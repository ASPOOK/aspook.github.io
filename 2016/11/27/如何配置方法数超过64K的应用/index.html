<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="请不要灰心，你也会有人妒忌"><title>如何配置方法数超过64K的应用 | Aspook</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">如何配置方法数超过64K的应用</h1><a id="logo" href="/.">Aspook</a><p class="description">『Serendipity』Battling against our own ignorance</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">如何配置方法数超过64K的应用</h1><div class="post-meta">Nov 27, 2016<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/11/27/如何配置方法数超过64K的应用/" href="/2016/11/27/如何配置方法数超过64K的应用/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>随着Android平台的继续成长，Android应用的大小也在变大。当一个应用及其引用的库到达一定的规模，在编译应用时就会遇到构建错误，这表示此App已经达到了Android构建系统的某个限制。在早期的构建系统版本中，此错误表现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Conversion to Dalvik format failed:</span><br><span class="line">Unable to execute dex: method ID not in [<span class="number">0</span>, <span class="number">0xffff</span>]: <span class="number">65536</span></span><br></pre></td></tr></table></figure>
<p>现在的Android构建系统可能会报另一个不同的错误，但它们表示的都是同一个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trouble writing output:</span><br><span class="line">Too many field references: <span class="number">131000</span>; max is <span class="number">65536</span>.</span><br><span class="line">You may <span class="keyword">try</span> using --multi-dex option.</span><br></pre></td></tr></table></figure>
<p>这些错误的发生条件都指向了一个共同的数字：65536，这个数字非常重要，它代表了一个单独的DEX字节码文件可执行的引用总数。本文将说明如何通过将一个应用配置为multidex的方式来解决该问题，配置之后，该应用将构建和读取多个DEX文件。</p>
<h3 id="u5173_u4E8E64K_u7684_u5F15_u7528_u9650_u5236"><a href="#u5173_u4E8E64K_u7684_u5F15_u7528_u9650_u5236" class="headerlink" title="关于64K的引用限制"></a>关于64K的引用限制</h3><p>Android 应用（APK）中以Dalvik虚拟机可执行文件（即DEX）的形式包含了可执行的字节码文件，DEX文件中编译后的代码则用于运行App功能。DEX规范做了如下限制：一个单独的DEX文件可引用的最多方法数为65636——包括Android框架中的方法、第三方库的方法以及自己代码中的方法。在计算机科学的表述中，K表示1024（或2^10）。因为65536即64x1024，所以65536的方法数限制也叫做64K引用限制。</p>
<h4 id="Android_5-0_u4E4B_u524D_u7684_u7248_u672C_u4F7F_u7528Mutidex"><a href="#Android_5-0_u4E4B_u524D_u7684_u7248_u672C_u4F7F_u7528Mutidex" class="headerlink" title="Android 5.0之前的版本使用Mutidex"></a>Android 5.0之前的版本使用Mutidex</h4><p>Android 5.0（API level 21）之前的版本使用Dalvik虚拟机来执行应用代码，默认情况下，Dalvik限制每个APK中只有一个classes.dex字节码文件。为了绕过这个限制，可以使用支持库<a href="https://developer.android.com/tools/support-library/features.html#multidex" target="_blank" rel="external">multidex support library</a>，它将作为主DEX的一部分，用来管理对额外的DEX文件及其代码的访问。</p>
<blockquote>
<p>说明：如果为minSdkVersion=20或更低的应用配置multidex，并且运行目标设备为Android 4.4（API level 20）或更低，此时Android Studio将禁止使用<a href="https://developer.android.com/tools/building/building-studio.html#instant-run" target="_blank" rel="external">Instant Run</a>。</p>
</blockquote>
<h4 id="Android_5-0_u53CA_u4E4B_u540E_u7684_u7248_u672C_u4F7F_u7528Multidex"><a href="#Android_5-0_u53CA_u4E4B_u540E_u7684_u7248_u672C_u4F7F_u7528Multidex" class="headerlink" title="Android 5.0及之后的版本使用Multidex"></a>Android 5.0及之后的版本使用Multidex</h4><p>Android 5.0 （API level 21）及更高版本使用ART 运行时，ART默认支持从APK文件中加载多个DEX文件。当应用安装时，ART将执行预编译，会扫描多个.dex文件，并将它们编译为一个单独的.oat文件用来被Android设备执行。因此如果minSdkVersion=21或者更高，则不再需要multidex支持库。</p>
<p>关于更多的Anroid 5.0运行时知识，请参考<a href="https://source.android.com/devices/tech/dalvik/index.html" target="_blank" rel="external">ART and Dalvik</a>。</p>
<blockquote>
<p>说明：当使用Instant Run时，如果应用的minSdkVersion=21或者更高，则Android Studio会自动为该应用配置multidex。由于Instant Run仅用于App编译的debug模式，因此仍然需要为release模式配置multidex来避免64K的限制。</p>
</blockquote>
<h3 id="u907F_u514D64K__u65B9_u6CD5_u6570_u7684_u9650_u5236"><a href="#u907F_u514D64K__u65B9_u6CD5_u6570_u7684_u9650_u5236" class="headerlink" title="避免64K 方法数的限制"></a>避免64K 方法数的限制</h3><p>在为App配置允许使用64K或更多的方法引用之前，我们应该采取措施来减少App中所需的方法总数，包括我们自定义的方法及引用库的方法。以下策略可以帮助我们避免触发DEX的64K限制：</p>
<ul>
<li><p>Review应用的直接依赖或传递依赖</p>
<p>Ensure any large library dependency you include in your app is used in a manner that outweighs the amount of code being added to the app. A common anti-pattern is to include a very large library because a few utility methods were useful. 减少应用的代码依赖可以有效地避免DEX引用限制。</p>
</li>
<li><p>使用ProGuard移除无用代码</p>
<p>为应用的release版本开启Proguard的<a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="external">Enable code shrinking</a>，代码压缩将不会把无用代码打包到APK中。</p>
</li>
</ul>
<p>使用上述方法可以帮助我们避免在应用中使用multidex，同时能够有效减少APK包的大小。</p>
<h3 id="u4E3A_u5E94_u7528_u914D_u7F6Emultidex"><a href="#u4E3A_u5E94_u7528_u914D_u7F6Emultidex" class="headerlink" title="为应用配置multidex"></a>为应用配置multidex</h3><p>为应用配置multidex需要对应用工程作一些修改，这取决于该App所支持的最低Android版本。</p>
<p>如果<code>minSdkVersion</code>设置为21或更高，那么只需要为module中的<code>build.gradle</code>文件添加<code>multiDexEnabled</code>为<code>true</code>，具体如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">android</span> &#123;</span><br><span class="line">    <span class="tag">defaultConfig</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">minSdkVersion</span> <span class="tag">21</span> </span><br><span class="line">        <span class="tag">targetSdkVersion</span> <span class="tag">25</span></span><br><span class="line">        <span class="tag">multiDexEnabled</span> <span class="tag">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>minSdkVersion</code>为20或更低，则必须使用<code>multidex support library</code>，具体操作如下：</p>
<ol>
<li><p>为Module中的<code>build.gradle</code>文件添加<code>multiDexEnabled</code>为<code>true</code>，并且添加multidex library依赖，如下所示：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        minSdkVersion <span class="number">15</span> </span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span> <span class="string">'com.android.support:multidex:1.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据是否重写了<code>Application</code>类，选择下面的对应方案：</p>
<ul>
<li><p>如果没有重写<code>Application</code>类，将AndroidManifest.xml中的<application>标签的<code>android:name</code>做如下设置：</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">package</span>=<span class="value">"com.example.myapp"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"android.support.multidex.MultiDexApplication"</span> &gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果重写了<code>Application</code>类，让它继承<code>MultiDexApplication</code>（如果可能）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果重写了<code>Application</code>类，但是它的基类无法修改，那么可以重写<code>attachBaseContext()</code>方法并且调用<code>MultiDex.install(this)</code>来允许使用multidex。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">SomeOtherApplication</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.attachBaseContext(context);</span><br><span class="line">     Multidex.install(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>现在当编译应用，Android构建工具将会构造一个主DEX文件（classes.dex），如果有需要的话还会生成其他DEX文件（如classes2.dex，classes3.dex等），构建系统然后会将所有的DEX文件打包到APK中。</p>
<p>在运行的时候，multidex API会使用特定的类加载器在所有可用的DEX文件中来搜索所需方法。</p>
<h4 id="multidex_support_library_u7684_u5C40_u9650_u6027"><a href="#multidex_support_library_u7684_u5C40_u9650_u6027" class="headerlink" title="multidex support library的局限性"></a>multidex support library的局限性</h4><p><code>multidex support library</code>有一些已知的局限性，在为应用配置multidex之前我们需要知道并测试：</p>
<ul>
<li>在启动时将DEX安装到设备的数据分区很复杂，如果第二个DEX文件很大的话，有可能导致ANR错误。这种情况下，我们需要开启<a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="external">code shrinking with ProGuard</a>来减小DEX的大小并移除无用代码。</li>
<li>一些使用了multidex的应用可能无法在低于Android 4.0（API level 14）的设备上运行，这可能是由于<code>Dalvik linarAlloc bug</code>（ <a href="http://b.android.com/22586" target="_blank" rel="external">Issue 22586</a>）引起。如果目标API的版本低于14，必须确保对这些平台版本展开充分测试，因为它们可能在启动或某些特殊类加载时产生异常。Code shrinking可以减少或消除这些潜在的问题。</li>
<li>使用了multidex的应用需要更多的内存分配，也可能导致应用崩溃，这是由于<code>Dalvik linearAlloc limit</code>（<a href="http://b.android.com/78035" target="_blank" rel="external">Issue 78053</a>）的原因。虽然内存分配限制在Android 4.0（API level 14）增加了，但App仍有可能在Android 5.0（API level 21）之前的版本中运行时到达上限。</li>
</ul>
<h3 id="u4E3A_u4E3BDEX__u6587_u4EF6_u58F0_u660E_u5FC5_u987B_u7C7B"><a href="#u4E3A_u4E3BDEX__u6587_u4EF6_u58F0_u660E_u5FC5_u987B_u7C7B" class="headerlink" title="为主DEX 文件声明必须类"></a>为主DEX 文件声明必须类</h3><p>为配置了multidex的应用构建每一个DEX文件时，构建工具需要做一个复杂的决策，来决定哪一个类是主DEX文件必须的，来保证应用能成功启动。如果某个在启动时必须的类没有被包含到主DEX文件，那么应用启动时就会崩溃，并报错<code>java.lang.NoClassDefFoundError</code>。</p>
<p>如果我们应用的代码可以直接访问某些代码，上述错误一般来说不会发生，因为构建工具可以识别出这些代码路径，但是当代码路径不可见时就可能会发生上述异常，如应用中的某个库包含了复杂的依赖。一个更具体的例子，如代码使用了反射或从Native代码调用Java方法，这些方法则可能不会被识别并放到主DEX文件中。</p>
<p>所以当遇到<code>java.lang.NoClassDefFoundError</code>时，需要手动指定哪些类为主DEX必须的，具体方法为通过在build type中使用<code>multiDexKeepFile</code>属性来声明它们。在这里指定的文件必须每个类声明为一行，书写格式为<code>com/example/MyClass.class</code>。例如，可以创建如下一个叫做dex.keep的文件：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com<span class="regexp">/example/My</span><span class="keyword">Class</span>.<span class="keyword">class</span></span><br><span class="line">com<span class="regexp">/example/My</span>OtherClass.<span class="keyword">class</span></span><br></pre></td></tr></table></figure>
<p>然后就可以为某个build type指定此文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">android</span> &#123;</span><br><span class="line">    <span class="title">buildTypes</span> &#123;</span><br><span class="line">        <span class="title">release</span> &#123;</span><br><span class="line">            <span class="title">multiDexKeepFile</span> file(<span class="string">'dex.keep'</span>)</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为Gradle是相对于build.gradle文件读取路径的，所以上述例子中的dex.keep需要跟build.gradle文件处于相同的目录才可生效。</p>
<h3 id="u5728_u5F00_u53D1_u4E2D_u4F18_u5316multidex_u7684_u6784_u5EFA_u8FC7_u7A0B"><a href="#u5728_u5F00_u53D1_u4E2D_u4F18_u5316multidex_u7684_u6784_u5EFA_u8FC7_u7A0B" class="headerlink" title="在开发中优化multidex的构建过程"></a>在开发中优化multidex的构建过程</h3><p>配置了Multidex的应用所需要的构建时间明显增加，因为构建系统需要做复杂的分析来决定哪些类需要包含在主DEX中，哪些类需要包含则其他DEX文件中。这意味着使用multidex的构建会花费更多时间并减慢我们的开发过程。</p>
<p>为了缩短multidex的构建时间，我们可以使用<code>productFlavors</code>创建两个构建变种：一个<code>development flavor</code>和一个<code>release flavor</code>，它们使用不同的minSdkVersion。</p>
<p>对于<code>development flavor</code>，将<code>minSdkVersion</code>设为21，此设置将会使用一种叫做<code>per-dexing</code>的构建功能，在使用ART模式时（Android 5.0或更高），它会更快地为multidex生成APK。对于<code>release flavor</code>，将<code>minSdkVersion</code>设置为应用真正要支持的最低版本，这种设置方式将会生成兼容更多设备的APK，但是需要花费更长的构建时间。</p>
<p>下面的构建配置说明了在Gradle中如何设置上述flavor：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        dev &#123;</span><br><span class="line">            <span class="comment">// Enable pre-dexing to produce an APK that can be tested on</span></span><br><span class="line">            <span class="comment">// Android 5.0+ without the time-consuming DEX build processes.</span></span><br><span class="line">            minSdkVersion <span class="number">21</span></span><br><span class="line">        &#125;</span><br><span class="line">        prod &#123;</span><br><span class="line">            <span class="comment">// The actual minSdkVersion for the production version.</span></span><br><span class="line">            minSdkVersion <span class="number">14</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>),</span><br><span class="line">                                                 <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:multidex:1.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成了上述配置后，就可以使用<code>devDebug</code>变种来进行增量构建，此种方式组合了<code>dev</code> product flavor以及<code>debug</code>构建类型。这将生成一个debug版的使用了multidex并且禁用proguard（因为<code>minifyEnabled</code>默认为false）的应用。上述配置会让Gradle插件做以下事情：</p>
<ol>
<li>执行<code>pre-dexing</code>：将每一个Module及每一个依赖编译成一个独立的DEX文件。</li>
<li>将每一个DEX文件不做任何修改地包含进APK文件中（没有执行代码压缩）。</li>
<li>最重要的是，每个Module生成的DEX没有组合起来，因此不需要花费很长时间来计算主DEX应该包含哪些内容。</li>
</ol>
<p>上述配置会使得构建加快，因为仅仅是发生修改的module会被重计算及打包构建出新的DEX文件，但是，上述配置生成的APK只能在Android 5.0的设备上测试。然而通过使用flavor配置，我们也可以使用通用的构建方式来生成APK，这些APK可以适配最低的SDK版本并且使用了<code>ProGuard</code>代码压缩。</p>
<p>还可以构建其他变种，如<code>prodDebug</code>，它会花费较长时间来构建，但是可以用来做开发之外的测试。<code>prodRelease</code>可作为最终的测试及发布版本。如需了解更多的构建变种知识，请参考 <a href="https://developer.android.com/studio/build/build-variants.html" target="_blank" rel="external">Configure Build Variants</a>。</p>
<h3 id="u6D4B_u8BD5multidex_u5E94_u7528"><a href="#u6D4B_u8BD5multidex_u5E94_u7528" class="headerlink" title="测试multidex应用"></a>测试multidex应用</h3><p>为multidex应用写测试用例时，无需其他配置。<code>AndroidJUnitRunner</code>支持multidex，只要你使用<code>MultiDexApplication</code>或者为自定义的<code>Application</code>重写<code>attachBaseContext()</code>方法并调用<code>MultiDex.install(this)</code>来开启muxtidex支持。</p>
<p>另外，可以在<code>AndroidJUnitRunner</code>中重写<code>onCreate()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">    MultiDex.install(getTargetContext());</span><br><span class="line">    <span class="keyword">super</span>.onCreate(arguments);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：使用multidex来创建一个测试APK目前是不支持的。</p>
</blockquote>
<p><a href="https://developer.android.com/studio/build/multidex.html" target="_blank" rel="external">原文地址</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://aspook.com/2016/11/27/如何配置方法数超过64K的应用/" data-id="ciwqf93ww0021ie5sjnq2wb1z" class="article-share-link">分享到</a><div class="tags"><a href="/tags/64K-method/">64K method</a><a href="/tags/65536/">65536</a></div><div class="post-nav"><a href="/2016/12/15/APK瘦身指南/" class="pre">APK瘦身指南</a><a href="/2016/10/25/关于日益泛滥的Android第三方框架/" class="next">关于日益泛滥的Android第三方框架</a></div><div id="disqus_thread"><script>var disqus_shortname = 'aspook';
var disqus_identifier = '2016/11/27/如何配置方法数超过64K的应用/';
var disqus_title = '如何配置方法数超过64K的应用';
var disqus_url = 'http://aspook.com/2016/11/27/如何配置方法数超过64K的应用/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//aspook.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://aspook.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms/">Algorithms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GIS/">GIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/深度优先遍历/" style="font-size: 15px;">深度优先遍历</a> <a href="/tags/APK瘦身/" style="font-size: 15px;">APK瘦身</a> <a href="/tags/微信wap支付/" style="font-size: 15px;">微信wap支付</a> <a href="/tags/微信网页支付/" style="font-size: 15px;">微信网页支付</a> <a href="/tags/诗词/" style="font-size: 15px;">诗词</a> <a href="/tags/历史/" style="font-size: 15px;">历史</a> <a href="/tags/Web地图/" style="font-size: 15px;">Web地图</a> <a href="/tags/矢量渲染/" style="font-size: 15px;">矢量渲染</a> <a href="/tags/切片地图/" style="font-size: 15px;">切片地图</a> <a href="/tags/栅格地图/" style="font-size: 15px;">栅格地图</a> <a href="/tags/养花/" style="font-size: 15px;">养花</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a> <a href="/tags/Java泛型/" style="font-size: 15px;">Java泛型</a> <a href="/tags/clone/" style="font-size: 15px;">clone</a> <a href="/tags/对象克隆/" style="font-size: 15px;">对象克隆</a> <a href="/tags/Android线程/" style="font-size: 15px;">Android线程</a> <a href="/tags/线程通信/" style="font-size: 15px;">线程通信</a> <a href="/tags/AsyncTask/" style="font-size: 15px;">AsyncTask</a> <a href="/tags/工具类/" style="font-size: 15px;">工具类</a> <a href="/tags/公有构造函数/" style="font-size: 15px;">公有构造函数</a> <a href="/tags/诗歌/" style="font-size: 15px;">诗歌</a> <a href="/tags/65536/" style="font-size: 15px;">65536</a> <a href="/tags/64K-method/" style="font-size: 15px;">64K method</a> <a href="/tags/App安全/" style="font-size: 15px;">App安全</a> <a href="/tags/Intent/" style="font-size: 15px;">Intent</a> <a href="/tags/垃圾收集算法/" style="font-size: 15px;">垃圾收集算法</a> <a href="/tags/在南下的火车上/" style="font-size: 15px;">在南下的火车上</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/第三方框架/" style="font-size: 15px;">第三方框架</a> <a href="/tags/Android适配/" style="font-size: 15px;">Android适配</a> <a href="/tags/人生信条/" style="font-size: 15px;">人生信条</a> <a href="/tags/Context/" style="font-size: 15px;">Context</a> <a href="/tags/二叉树/" style="font-size: 15px;">二叉树</a> <a href="/tags/二叉树遍历/" style="font-size: 15px;">二叉树遍历</a> <a href="/tags/微信支付/" style="font-size: 15px;">微信支付</a> <a href="/tags/广度优先遍历/" style="font-size: 15px;">广度优先遍历</a> <a href="/tags/非递归实现/" style="font-size: 15px;">非递归实现</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/AndroidManifest/" style="font-size: 15px;">AndroidManifest</a> <a href="/tags/activity-alias/" style="font-size: 15px;">activity-alias</a> <a href="/tags/瓦片地图/" style="font-size: 15px;">瓦片地图</a> <a href="/tags/Messenger/" style="font-size: 15px;">Messenger</a> <a href="/tags/进程间通信/" style="font-size: 15px;">进程间通信</a> <a href="/tags/LRU/" style="font-size: 15px;">LRU</a> <a href="/tags/Java内存模型/" style="font-size: 15px;">Java内存模型</a> <a href="/tags/JVM内存模型/" style="font-size: 15px;">JVM内存模型</a> <a href="/tags/Java内存分配/" style="font-size: 15px;">Java内存分配</a> <a href="/tags/Bundle/" style="font-size: 15px;">Bundle</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/AIDL/" style="font-size: 15px;">AIDL</a> <a href="/tags/Binder/" style="font-size: 15px;">Binder</a> <a href="/tags/Android消息机制源码解析/" style="font-size: 15px;">Android消息机制源码解析</a> <a href="/tags/MessageQueue/" style="font-size: 15px;">MessageQueue</a> <a href="/tags/Handler/" style="font-size: 15px;">Handler</a> <a href="/tags/Looper/" style="font-size: 15px;">Looper</a> <a href="/tags/Message/" style="font-size: 15px;">Message</a> <a href="/tags/Android文件存储/" style="font-size: 15px;">Android文件存储</a> <a href="/tags/内部存储/" style="font-size: 15px;">内部存储</a> <a href="/tags/外部存储/" style="font-size: 15px;">外部存储</a> <a href="/tags/微信分享/" style="font-size: 15px;">微信分享</a> <a href="/tags/分享闭环/" style="font-size: 15px;">分享闭环</a> <a href="/tags/Android书籍推荐/" style="font-size: 15px;">Android书籍推荐</a> <a href="/tags/App生命周期/" style="font-size: 15px;">App生命周期</a> <a href="/tags/Broadcast/" style="font-size: 15px;">Broadcast</a> <a href="/tags/Android广播/" style="font-size: 15px;">Android广播</a> <a href="/tags/Android图片缓存/" style="font-size: 15px;">Android图片缓存</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/Android-Studio/" style="font-size: 15px;">Android Studio</a> <a href="/tags/Instant-Run/" style="font-size: 15px;">Instant Run</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/15/APK瘦身指南/">APK瘦身指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/27/如何配置方法数超过64K的应用/">如何配置方法数超过64K的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/关于日益泛滥的Android第三方框架/">关于日益泛滥的Android第三方框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/30/Messenger进程间通信及其原理/">Messenger进程间通信及其原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/30/信条/">信条</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/Android消息机制源码解析（四）——消息队列MessageQueue/">Android消息机制源码解析（四）——消息队列MessageQueue</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/Android消息机制源码解析（三）——消息循环器Looper/">Android消息机制源码解析（三）——消息循环器Looper</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/Android消息机制源码解析（二）——消息执行者Handler/">Android消息机制源码解析（二）——消息执行者Handler</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/24/Android消息机制源码解析（一）——消息载体Message/">Android消息机制源码解析（一）——消息载体Message</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/15/潜心做一名花匠/">潜心做一名花匠</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//aspook.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/ahence" title="aspook" target="_blank">aspook</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Aspook.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>