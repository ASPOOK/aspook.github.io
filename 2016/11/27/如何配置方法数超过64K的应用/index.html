<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="如何配置方法数超过64K的应用"/>




  <meta name="keywords" content="64K method, 65536, ASPOOK" />










  <link rel="alternative" href="/default" title="ASPOOK" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://aspook.com/2016/11/27/如何配置方法数超过64K的应用/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> 如何配置方法数超过64K的应用 - ASPOOK </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">ASPOOK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">ASPOOK</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          如何配置方法数超过64K的应用
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-11-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#u5173_u4E8E64K_u7684_u5F15_u7528_u9650_u5236"><span class="toc-text">关于64K的引用限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Android_5-0_u4E4B_u524D_u7684_u7248_u672C_u4F7F_u7528Mutidex"><span class="toc-text">Android 5.0之前的版本使用Mutidex</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Android_5-0_u53CA_u4E4B_u540E_u7684_u7248_u672C_u4F7F_u7528Multidex"><span class="toc-text">Android 5.0及之后的版本使用Multidex</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u907F_u514D64K__u65B9_u6CD5_u6570_u7684_u9650_u5236"><span class="toc-text">避免64K 方法数的限制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u4E3A_u5E94_u7528_u914D_u7F6Emultidex"><span class="toc-text">为应用配置multidex</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#multidex_support_library_u7684_u5C40_u9650_u6027"><span class="toc-text">multidex support library的局限性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u4E3A_u4E3BDEX__u6587_u4EF6_u58F0_u660E_u5FC5_u987B_u7C7B"><span class="toc-text">为主DEX 文件声明必须类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u5728_u5F00_u53D1_u4E2D_u4F18_u5316multidex_u7684_u6784_u5EFA_u8FC7_u7A0B"><span class="toc-text">在开发中优化multidex的构建过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u6D4B_u8BD5multidex_u5E94_u7528"><span class="toc-text">测试multidex应用</span></a></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <p>随着Android平台的继续成长，Android应用的大小也在变大。当一个应用及其引用的库到达一定的规模，在编译应用时就会遇到构建错误，这表示此App已经达到了Android构建系统的某个限制。在早期的构建系统版本中，此错误表现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Conversion to Dalvik format failed:</span><br><span class="line">Unable to execute dex: method ID not in [<span class="number">0</span>, <span class="number">0xffff</span>]: <span class="number">65536</span></span><br></pre></td></tr></table></figure>
<p>现在的Android构建系统可能会报另一个不同的错误，但它们表示的都是同一个问题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">trouble writing output:</span><br><span class="line">Too many field references: <span class="number">131000</span>; max is <span class="number">65536</span>.</span><br><span class="line">You may <span class="keyword">try</span> using --multi-dex option.</span><br></pre></td></tr></table></figure>
<p>这些错误的发生条件都指向了一个共同的数字：65536，这个数字非常重要，它代表了一个单独的DEX字节码文件可执行的引用总数。本文将说明如何通过将一个应用配置为multidex的方式来解决该问题，配置之后，该应用将构建和读取多个DEX文件。</p>
<h3 id="u5173_u4E8E64K_u7684_u5F15_u7528_u9650_u5236"><a href="#u5173_u4E8E64K_u7684_u5F15_u7528_u9650_u5236" class="headerlink" title="关于64K的引用限制"></a>关于64K的引用限制</h3><p>Android 应用（APK）中以Dalvik虚拟机可执行文件（即DEX）的形式包含了可执行的字节码文件，DEX文件中编译后的代码则用于运行App功能。DEX规范做了如下限制：一个单独的DEX文件可引用的最多方法数为65636——包括Android框架中的方法、第三方库的方法以及自己代码中的方法。在计算机科学的表述中，K表示1024（或2^10）。因为65536即64x1024，所以65536的方法数限制也叫做64K引用限制。</p>
<h4 id="Android_5-0_u4E4B_u524D_u7684_u7248_u672C_u4F7F_u7528Mutidex"><a href="#Android_5-0_u4E4B_u524D_u7684_u7248_u672C_u4F7F_u7528Mutidex" class="headerlink" title="Android 5.0之前的版本使用Mutidex"></a>Android 5.0之前的版本使用Mutidex</h4><p>Android 5.0（API level 21）之前的版本使用Dalvik虚拟机来执行应用代码，默认情况下，Dalvik限制每个APK中只有一个classes.dex字节码文件。为了绕过这个限制，可以使用支持库<a href="https://developer.android.com/tools/support-library/features.html#multidex" target="_blank" rel="external">multidex support library</a>，它将作为主DEX的一部分，用来管理对额外的DEX文件及其代码的访问。</p>
<blockquote>
<p>说明：如果为minSdkVersion=20或更低的应用配置multidex，并且运行目标设备为Android 4.4（API level 20）或更低，此时Android Studio将禁止使用<a href="https://developer.android.com/tools/building/building-studio.html#instant-run" target="_blank" rel="external">Instant Run</a>。</p>
</blockquote>
<h4 id="Android_5-0_u53CA_u4E4B_u540E_u7684_u7248_u672C_u4F7F_u7528Multidex"><a href="#Android_5-0_u53CA_u4E4B_u540E_u7684_u7248_u672C_u4F7F_u7528Multidex" class="headerlink" title="Android 5.0及之后的版本使用Multidex"></a>Android 5.0及之后的版本使用Multidex</h4><p>Android 5.0 （API level 21）及更高版本使用ART 运行时，ART默认支持从APK文件中加载多个DEX文件。当应用安装时，ART将执行预编译，会扫描多个.dex文件，并将它们编译为一个单独的.oat文件用来被Android设备执行。因此如果minSdkVersion=21或者更高，则不再需要multidex支持库。</p>
<p>关于更多的Anroid 5.0运行时知识，请参考<a href="https://source.android.com/devices/tech/dalvik/index.html" target="_blank" rel="external">ART and Dalvik</a>。</p>
<blockquote>
<p>说明：当使用Instant Run时，如果应用的minSdkVersion=21或者更高，则Android Studio会自动为该应用配置multidex。由于Instant Run仅用于App编译的debug模式，因此仍然需要为release模式配置multidex来避免64K的限制。</p>
</blockquote>
<h3 id="u907F_u514D64K__u65B9_u6CD5_u6570_u7684_u9650_u5236"><a href="#u907F_u514D64K__u65B9_u6CD5_u6570_u7684_u9650_u5236" class="headerlink" title="避免64K 方法数的限制"></a>避免64K 方法数的限制</h3><p>在为App配置允许使用64K或更多的方法引用之前，我们应该采取措施来减少App中所需的方法总数，包括我们自定义的方法及引用库的方法。以下策略可以帮助我们避免触发DEX的64K限制：</p>
<ul>
<li><p>Review应用的直接依赖或传递依赖</p>
<p>Ensure any large library dependency you include in your app is used in a manner that outweighs the amount of code being added to the app. A common anti-pattern is to include a very large library because a few utility methods were useful. 减少应用的代码依赖可以有效地避免DEX引用限制。</p>
</li>
<li><p>使用ProGuard移除无用代码</p>
<p>为应用的release版本开启Proguard的<a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="external">Enable code shrinking</a>，代码压缩将不会把无用代码打包到APK中。</p>
</li>
</ul>
<p>使用上述方法可以帮助我们避免在应用中使用multidex，同时能够有效减少APK包的大小。</p>
<h3 id="u4E3A_u5E94_u7528_u914D_u7F6Emultidex"><a href="#u4E3A_u5E94_u7528_u914D_u7F6Emultidex" class="headerlink" title="为应用配置multidex"></a>为应用配置multidex</h3><p>为应用配置multidex需要对应用工程作一些修改，这取决于该App所支持的最低Android版本。</p>
<p>如果<code>minSdkVersion</code>设置为21或更高，那么只需要为module中的<code>build.gradle</code>文件添加<code>multiDexEnabled</code>为<code>true</code>，具体如下：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">android</span> &#123;</span><br><span class="line">    <span class="tag">defaultConfig</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">minSdkVersion</span> <span class="tag">21</span> </span><br><span class="line">        <span class="tag">targetSdkVersion</span> <span class="tag">25</span></span><br><span class="line">        <span class="tag">multiDexEnabled</span> <span class="tag">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>minSdkVersion</code>为20或更低，则必须使用<code>multidex support library</code>，具体操作如下：</p>
<ol>
<li><p>为Module中的<code>build.gradle</code>文件添加<code>multiDexEnabled</code>为<code>true</code>，并且添加multidex library依赖，如下所示：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        minSdkVersion <span class="number">15</span> </span><br><span class="line">        targetSdkVersion <span class="number">25</span></span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">  <span class="keyword">compile</span> <span class="string">'com.android.support:multidex:1.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据是否重写了<code>Application</code>类，选择下面的对应方案：</p>
<ul>
<li><p>如果没有重写<code>Application</code>类，将AndroidManifest.xml中的<application>标签的<code>android:name</code>做如下设置：</application></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">manifest</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span></span><br><span class="line">    <span class="attribute">package</span>=<span class="value">"com.example.myapp"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">application</span></span><br><span class="line">            <span class="attribute">android:name</span>=<span class="value">"android.support.multidex.MultiDexApplication"</span> &gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="title">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果重写了<code>Application</code>类，让它继承<code>MultiDexApplication</code>（如果可能）：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果重写了<code>Application</code>类，但是它的基类无法修改，那么可以重写<code>attachBaseContext()</code>方法并且调用<code>MultiDex.install(this)</code>来允许使用multidex。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">SomeOtherApplication</span> </span>&#123;</span><br><span class="line">  <span class="annotation">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.attachBaseContext(context);</span><br><span class="line">     Multidex.install(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>现在当编译应用，Android构建工具将会构造一个主DEX文件（classes.dex），如果有需要的话还会生成其他DEX文件（如classes2.dex，classes3.dex等），构建系统然后会将所有的DEX文件打包到APK中。</p>
<p>在运行的时候，multidex API会使用特定的类加载器在所有可用的DEX文件中来搜索所需方法。</p>
<h4 id="multidex_support_library_u7684_u5C40_u9650_u6027"><a href="#multidex_support_library_u7684_u5C40_u9650_u6027" class="headerlink" title="multidex support library的局限性"></a>multidex support library的局限性</h4><p><code>multidex support library</code>有一些已知的局限性，在为应用配置multidex之前我们需要知道并测试：</p>
<ul>
<li>在启动时将DEX安装到设备的数据分区很复杂，如果第二个DEX文件很大的话，有可能导致ANR错误。这种情况下，我们需要开启<a href="https://developer.android.com/studio/build/shrink-code.html" target="_blank" rel="external">code shrinking with ProGuard</a>来减小DEX的大小并移除无用代码。</li>
<li>一些使用了multidex的应用可能无法在低于Android 4.0（API level 14）的设备上运行，这可能是由于<code>Dalvik linarAlloc bug</code>（ <a href="http://b.android.com/22586" target="_blank" rel="external">Issue 22586</a>）引起。如果目标API的版本低于14，必须确保对这些平台版本展开充分测试，因为它们可能在启动或某些特殊类加载时产生异常。Code shrinking可以减少或消除这些潜在的问题。</li>
<li>使用了multidex的应用需要更多的内存分配，也可能导致应用崩溃，这是由于<code>Dalvik linearAlloc limit</code>（<a href="http://b.android.com/78035" target="_blank" rel="external">Issue 78053</a>）的原因。虽然内存分配限制在Android 4.0（API level 14）增加了，但App仍有可能在Android 5.0（API level 21）之前的版本中运行时到达上限。</li>
</ul>
<h3 id="u4E3A_u4E3BDEX__u6587_u4EF6_u58F0_u660E_u5FC5_u987B_u7C7B"><a href="#u4E3A_u4E3BDEX__u6587_u4EF6_u58F0_u660E_u5FC5_u987B_u7C7B" class="headerlink" title="为主DEX 文件声明必须类"></a>为主DEX 文件声明必须类</h3><p>为配置了multidex的应用构建每一个DEX文件时，构建工具需要做一个复杂的决策，来决定哪一个类是主DEX文件必须的，来保证应用能成功启动。如果某个在启动时必须的类没有被包含到主DEX文件，那么应用启动时就会崩溃，并报错<code>java.lang.NoClassDefFoundError</code>。</p>
<p>如果我们应用的代码可以直接访问某些代码，上述错误一般来说不会发生，因为构建工具可以识别出这些代码路径，但是当代码路径不可见时就可能会发生上述异常，如应用中的某个库包含了复杂的依赖。一个更具体的例子，如代码使用了反射或从Native代码调用Java方法，这些方法则可能不会被识别并放到主DEX文件中。</p>
<p>所以当遇到<code>java.lang.NoClassDefFoundError</code>时，需要手动指定哪些类为主DEX必须的，具体方法为通过在build type中使用<code>multiDexKeepFile</code>属性来声明它们。在这里指定的文件必须每个类声明为一行，书写格式为<code>com/example/MyClass.class</code>。例如，可以创建如下一个叫做dex.keep的文件：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com<span class="regexp">/example/My</span><span class="keyword">Class</span>.<span class="keyword">class</span></span><br><span class="line">com<span class="regexp">/example/My</span>OtherClass.<span class="keyword">class</span></span><br></pre></td></tr></table></figure>
<p>然后就可以为某个build type指定此文件：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">android</span> &#123;</span><br><span class="line">    <span class="title">buildTypes</span> &#123;</span><br><span class="line">        <span class="title">release</span> &#123;</span><br><span class="line">            <span class="title">multiDexKeepFile</span> file(<span class="string">'dex.keep'</span>)</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为Gradle是相对于build.gradle文件读取路径的，所以上述例子中的dex.keep需要跟build.gradle文件处于相同的目录才可生效。</p>
<h3 id="u5728_u5F00_u53D1_u4E2D_u4F18_u5316multidex_u7684_u6784_u5EFA_u8FC7_u7A0B"><a href="#u5728_u5F00_u53D1_u4E2D_u4F18_u5316multidex_u7684_u6784_u5EFA_u8FC7_u7A0B" class="headerlink" title="在开发中优化multidex的构建过程"></a>在开发中优化multidex的构建过程</h3><p>配置了Multidex的应用所需要的构建时间明显增加，因为构建系统需要做复杂的分析来决定哪些类需要包含在主DEX中，哪些类需要包含则其他DEX文件中。这意味着使用multidex的构建会花费更多时间并减慢我们的开发过程。</p>
<p>为了缩短multidex的构建时间，我们可以使用<code>productFlavors</code>创建两个构建变种：一个<code>development flavor</code>和一个<code>release flavor</code>，它们使用不同的minSdkVersion。</p>
<p>对于<code>development flavor</code>，将<code>minSdkVersion</code>设为21，此设置将会使用一种叫做<code>per-dexing</code>的构建功能，在使用ART模式时（Android 5.0或更高），它会更快地为multidex生成APK。对于<code>release flavor</code>，将<code>minSdkVersion</code>设置为应用真正要支持的最低版本，这种设置方式将会生成兼容更多设备的APK，但是需要花费更长的构建时间。</p>
<p>下面的构建配置说明了在Gradle中如何设置上述flavor：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        multiDexEnabled <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        dev &#123;</span><br><span class="line">            <span class="comment">// Enable pre-dexing to produce an APK that can be tested on</span></span><br><span class="line">            <span class="comment">// Android 5.0+ without the time-consuming DEX build processes.</span></span><br><span class="line">            minSdkVersion <span class="number">21</span></span><br><span class="line">        &#125;</span><br><span class="line">        prod &#123;</span><br><span class="line">            <span class="comment">// The actual minSdkVersion for the production version.</span></span><br><span class="line">            minSdkVersion <span class="number">14</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="keyword">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>),</span><br><span class="line">                                                 <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">dependencies</span> &#123;</span><br><span class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:multidex:1.0.1'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>完成了上述配置后，就可以使用<code>devDebug</code>变种来进行增量构建，此种方式组合了<code>dev</code> product flavor以及<code>debug</code>构建类型。这将生成一个debug版的使用了multidex并且禁用proguard（因为<code>minifyEnabled</code>默认为false）的应用。上述配置会让Gradle插件做以下事情：</p>
<ol>
<li>执行<code>pre-dexing</code>：将每一个Module及每一个依赖编译成一个独立的DEX文件。</li>
<li>将每一个DEX文件不做任何修改地包含进APK文件中（没有执行代码压缩）。</li>
<li>最重要的是，每个Module生成的DEX没有组合起来，因此不需要花费很长时间来计算主DEX应该包含哪些内容。</li>
</ol>
<p>上述配置会使得构建加快，因为仅仅是发生修改的module会被重计算及打包构建出新的DEX文件，但是，上述配置生成的APK只能在Android 5.0的设备上测试。然而通过使用flavor配置，我们也可以使用通用的构建方式来生成APK，这些APK可以适配最低的SDK版本并且使用了<code>ProGuard</code>代码压缩。</p>
<p>还可以构建其他变种，如<code>prodDebug</code>，它会花费较长时间来构建，但是可以用来做开发之外的测试。<code>prodRelease</code>可作为最终的测试及发布版本。如需了解更多的构建变种知识，请参考 <a href="https://developer.android.com/studio/build/build-variants.html" target="_blank" rel="external">Configure Build Variants</a>。</p>
<h3 id="u6D4B_u8BD5multidex_u5E94_u7528"><a href="#u6D4B_u8BD5multidex_u5E94_u7528" class="headerlink" title="测试multidex应用"></a>测试multidex应用</h3><p>为multidex应用写测试用例时，无需其他配置。<code>AndroidJUnitRunner</code>支持multidex，只要你使用<code>MultiDexApplication</code>或者为自定义的<code>Application</code>重写<code>attachBaseContext()</code>方法并调用<code>MultiDex.install(this)</code>来开启muxtidex支持。</p>
<p>另外，可以在<code>AndroidJUnitRunner</code>中重写<code>onCreate()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">    MultiDex.install(getTargetContext());</span><br><span class="line">    <span class="keyword">super</span>.onCreate(arguments);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：使用multidex来创建一个测试APK目前是不支持的。</p>
</blockquote>
<p><a href="https://developer.android.com/studio/build/multidex.html" target="_blank" rel="external">原文地址</a></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://aspook.com">AN</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://aspook.com/2016/11/27/如何配置方法数超过64K的应用/">http://aspook.com/2016/11/27/如何配置方法数超过64K的应用/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/64K-method/">64K method</a>
            
              <a href="/tags/65536/">65536</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2016/12/15/APK瘦身指南/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">APK瘦身指南</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2016/10/25/关于日益泛滥的Android第三方框架/">
        <span class="next-text nav-default">关于日益泛滥的Android第三方框架</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">AN</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
