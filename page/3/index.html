<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="请不要灰心，你也会有人妒忌"/>













  <link rel="alternative" href="/default" title="ASPOOK" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://aspook.com/page/3/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> ASPOOK </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">ASPOOK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">ASPOOK</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/08/16/关于Android适配的几条定律/">关于Android适配的几条定律</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-08-16
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <ol>
<li><p>在Android中一旦涉及到系统版本或厂商机型的话，几乎没有一个普适的规则。</p>
<blockquote>
<p>例如在4.0系统上正常，在6.0系统上则不一定正常；在原生系统上正常的话，在小米系统上则不一定正常；在小米手机上正常，在三星或华为手机上则不一定正常，通常比较坑的就是小米、魅族、乐视等手机，更不用说各种品牌的山寨机对操作系统的胡乱定制了。</p>
</blockquote>
</li>
<li><p>某个功能在部分测试机上正常，但不一定在所有手机上都正常，所以云测试很重要。</p>
</li>
<li><p>如果有用户反馈说某台手机某个功能不正常，通常来说都是对的。</p>
</li>
</ol>
<p>都是Android碎片化（包括设备、系统、屏幕等碎片化）带给开发者的痛，不多说了，满满的都是泪啊！</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/08/16/Android-Window纪要/">Android Window纪要</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-08-16
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="Window_u6982_u5FF5_u7406_u89E3"><a href="#Window_u6982_u5FF5_u7406_u89E3" class="headerlink" title="Window概念理解"></a>Window概念理解</h4><p>在Andriod开发中经常提到Activity和View，而位于它们之间的Window却较少涉及。Window所表示的是一个抽象的概念，实际上所有View都是依附于Window之上的，包括Activity中的视图、Dialog中的视图以及Toast中的视图。另外View的事件分发也是由Window传递给View的。</p>
<h4 id="Window_u7684_u7BA1_u7406"><a href="#Window_u7684_u7BA1_u7406" class="headerlink" title="Window的管理"></a>Window的管理</h4><p>Window是一个抽象类，其具体实现为PhoneWindow，Window通过WindowMaganer来管理，如添加、修改和删除等操作。WindowManager是一个接口，其具体实现类为WindowManagerImpl，有如下几个比较重要的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    applyDefaultToken(params);</span><br><span class="line">    mGlobal.addView(view, params, mDisplay, mParentWindow);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateViewLayout</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</span><br><span class="line">    applyDefaultToken(params);</span><br><span class="line">    mGlobal.updateViewLayout(view, params);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeView</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    mGlobal.removeView(view, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeViewImmediate</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">    mGlobal.removeView(view, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上述源码可知这几个方法的内部实现是由WindowManagerGlobal实现的。</p>
<h4 id="Window_u4E0EActivity_u7684_u5173_u8054"><a href="#Window_u4E0EActivity_u7684_u5173_u8054" class="headerlink" title="Window与Activity的关联"></a>Window与Activity的关联</h4><p>通过Activity源码可知，Activity实现了Window.Callback，该接口定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * API from a Window back to its caller.  This allows the client to</span><br><span class="line"> * intercept key dispatching, panels and menus, etc.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process key events.  At the very least your</span><br><span class="line">     * implementation must call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> android.view.Window#superDispatchKeyEvent&#125; to do the</span><br><span class="line">     * standard key processing.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The key event.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true if this event was consumed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyEvent</span><span class="params">(KeyEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process a key shortcut event.</span><br><span class="line">     * At the very least your implementation must call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> android.view.Window#superDispatchKeyShortcutEvent&#125; to do the</span><br><span class="line">     * standard key shortcut processing.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The key shortcut event.</span><br><span class="line">     * <span class="doctag">@return</span> True if this event was consumed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchKeyShortcutEvent</span><span class="params">(KeyEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process touch screen events.  At the very least your</span><br><span class="line">     * implementation must call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> android.view.Window#superDispatchTouchEvent&#125; to do the</span><br><span class="line">     * standard touch screen processing.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The touch screen event.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true if this event was consumed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process trackball events.  At the very least your</span><br><span class="line">     * implementation must call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> android.view.Window#superDispatchTrackballEvent&#125; to do the</span><br><span class="line">     * standard trackball processing.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The trackball event.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true if this event was consumed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTrackballEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process generic motion events.  At the very least your</span><br><span class="line">     * implementation must call</span><br><span class="line">     * &#123;<span class="doctag">@link</span> android.view.Window#superDispatchGenericMotionEvent&#125; to do the</span><br><span class="line">     * standard processing.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The generic motion event.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true if this event was consumed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchGenericMotionEvent</span><span class="params">(MotionEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called to process population of &#123;<span class="doctag">@link</span> AccessibilityEvent&#125;s.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> event The event.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true if event population was completed.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchPopulateAccessibilityEvent</span><span class="params">(AccessibilityEvent event)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Instantiate the view to display in the panel for 'featureId'.</span><br><span class="line">     * You can return null, in which case the default content (typically</span><br><span class="line">     * a menu) will be created for you.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId Which panel is being created.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> view The top-level view to place in the panel.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #onPreparePanel</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreatePanelView</span><span class="params">(<span class="keyword">int</span> featureId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Initialize the contents of the menu for panel 'featureId'.  This is</span><br><span class="line">     * called if onCreatePanelView() returns null, giving you a standard</span><br><span class="line">     * menu in which you can place your items.  It is only called once for</span><br><span class="line">     * the panel, the first time it is shown.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;You can safely hold on to &lt;var&gt;menu&lt;/var&gt; (and any items created</span><br><span class="line">     * from it), making modifications to it as desired, until the next</span><br><span class="line">     * time onCreatePanelMenu() is called for this feature.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId The panel being created.</span><br><span class="line">     * <span class="doctag">@param</span> menu The menu inside the panel.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean You must return true for the panel to be displayed;</span><br><span class="line">     *         if you return false it will not be shown.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreatePanelMenu</span><span class="params">(<span class="keyword">int</span> featureId, Menu menu)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Prepare a panel to be displayed.  This is called right before the</span><br><span class="line">     * panel window is shown, every time it is shown.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId The panel that is being displayed.</span><br><span class="line">     * <span class="doctag">@param</span> view The View that was returned by onCreatePanelView().</span><br><span class="line">     * <span class="doctag">@param</span> menu If onCreatePanelView() returned null, this is the Menu</span><br><span class="line">     *             being displayed in the panel.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean You must return true for the panel to be displayed;</span><br><span class="line">     *         if you return false it will not be shown.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #onCreatePanelView</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPreparePanel</span><span class="params">(<span class="keyword">int</span> featureId, View view, Menu menu)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when a panel's menu is opened by the user. This may also be</span><br><span class="line">     * called when the menu is changing from one type to another (for</span><br><span class="line">     * example, from the icon menu to the expanded menu).</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId The panel that the menu is in.</span><br><span class="line">     * <span class="doctag">@param</span> menu The menu that is opened.</span><br><span class="line">     * <span class="doctag">@return</span> Return true to allow the menu to open, or false to prevent</span><br><span class="line">     *         the menu from opening.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMenuOpened</span><span class="params">(<span class="keyword">int</span> featureId, Menu menu)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when a panel's menu item has been selected by the user.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId The panel that the menu is in.</span><br><span class="line">     * <span class="doctag">@param</span> item The menu item that was selected.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> boolean Return true to finish processing of selection, or</span><br><span class="line">     *         false to perform the normal menu handling (calling its</span><br><span class="line">     *         Runnable or sending a Message to its target Handler).</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onMenuItemSelected</span><span class="params">(<span class="keyword">int</span> featureId, MenuItem item)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This is called whenever the current window attributes change.</span><br><span class="line">     *</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowAttributesChanged</span><span class="params">(WindowManager.LayoutParams attrs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This hook is called whenever the content view of the screen changes</span><br><span class="line">     * (due to a call to</span><br><span class="line">     * &#123;<span class="doctag">@link</span> Window#setContentView(View, android.view.ViewGroup.LayoutParams)</span><br><span class="line">     * Window.setContentView&#125; or</span><br><span class="line">     * &#123;<span class="doctag">@link</span> Window#addContentView(View, android.view.ViewGroup.LayoutParams)</span><br><span class="line">     * Window.addContentView&#125;).</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onContentChanged</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * This hook is called whenever the window focus changes.  See</span><br><span class="line">     * &#123;<span class="doctag">@link</span> View#onWindowFocusChanged(boolean)</span><br><span class="line">     * View.onWindowFocusChanged(boolean)&#125; for more information.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> hasFocus Whether the window now has focus.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWindowFocusChanged</span><span class="params">(<span class="keyword">boolean</span> hasFocus)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when the window has been attached to the window manager.</span><br><span class="line">     * See &#123;<span class="doctag">@link</span> View#onAttachedToWindow() View.onAttachedToWindow()&#125;</span><br><span class="line">     * for more information.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAttachedToWindow</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when the window has been attached to the window manager.</span><br><span class="line">     * See &#123;<span class="doctag">@link</span> View#onDetachedFromWindow() View.onDetachedFromWindow()&#125;</span><br><span class="line">     * for more information.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when a panel is being closed.  If another logical subsequent</span><br><span class="line">     * panel is being opened (and this panel is being closed to make room for the subsequent</span><br><span class="line">     * panel), this method will NOT be called.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> featureId The panel that is being displayed.</span><br><span class="line">     * <span class="doctag">@param</span> menu If onCreatePanelView() returned null, this is the Menu</span><br><span class="line">     *            being displayed in the panel.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPanelClosed</span><span class="params">(<span class="keyword">int</span> featureId, Menu menu)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when the user signals the desire to start a search.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@return</span> true if search launched, false if activity refuses (blocks)</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> android.app.Activity#onSearchRequested()</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSearchRequested</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when an action mode is being started for this window. Gives the</span><br><span class="line">     * callback an opportunity to handle the action mode in its own unique and</span><br><span class="line">     * beautiful way. If this method returns null the system can choose a way</span><br><span class="line">     * to present the mode or choose not to start the mode at all.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> callback Callback to control the lifecycle of this action mode</span><br><span class="line">     * <span class="doctag">@return</span> The ActionMode that was started, or null if the system should present it</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Nullable</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ActionMode <span class="title">onWindowStartingActionMode</span><span class="params">(ActionMode.Callback callback)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when an action mode has been started. The appropriate mode callback</span><br><span class="line">     * method will have already been invoked.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> mode The new mode that has just been started.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActionModeStarted</span><span class="params">(ActionMode mode)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Called when an action mode has been finished. The appropriate mode callback</span><br><span class="line">     * method will have already been invoked.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> mode The mode that was just finished.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActionModeFinished</span><span class="params">(ActionMode mode)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中常见的有如下几个回调：</p>
<ul>
<li><code>public boolean dispatchTouchEvent(MotionEvent event);</code></li>
<li><code>public void onWindowFocusChanged(boolean hasFocus);</code></li>
<li><code>public void onAttachedToWindow();</code></li>
<li><code>public void onDetachedFromWindow();</code></li>
</ul>
<p>由此可见，很多关于Window的回调都是在Activity中处理的，它们的关系非常紧密。</p>
<p>当Activity被创建时，会为该Activity创建一个Window对象，由于Activity实现了Window.Callback，因此对于Window的操作就会在Activity中回调。创建完Window后，就需要把Activity的视图附加到Window上了。这个过程的步骤如下：</p>
<ol>
<li><p>Activity中的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Set the activity content from a layout resource.  The resource will be</span><br><span class="line"> * inflated, adding all top-level views to the activity.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> layoutResID Resource ID to be inflated.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View)</span><br><span class="line"> * <span class="doctag">@see</span> #setContentView(android.view.View, android.view.ViewGroup.LayoutParams)</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</span><br><span class="line">    getWindow().setContentView(layoutResID);</span><br><span class="line">    initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Activity把添加视图的任务交给Window来处理，而Window会先创建一个DecorView(是一个FrameLayout)，DecorView包含一个ID为android.R.id.content的内容区，其实质也是一个FrameLayout。</p>
</li>
<li><p>在Activity中经常调用的setContentView（int resId），就是把我们的视图添加到DecorView的内容区，也正因为如此，这个添加视图的方法不叫setView，而叫setContentView。添加完成后，Activity的onContentChanged被回调。</p>
</li>
<li><p>DecorView添加好视图后，还需要使用WindowMagager的addView方法将其添加到Window中。</p>
</li>
<li><p>以上步骤之后，所添加的视图并不可见，当Activity执行onResume()之后，才会将DecorView设置为可见，这样用户才真正看到了Activity的视图并可以接收用户交互。</p>
</li>
</ol>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/08/03/Android图片缓存机制（Caching-Bitmaps）/">Android图片缓存机制（Caching Bitmaps）</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-08-03
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>Android加载一张图片到用户界面是很简单的，但是当一次加载多张图片时，情况就变得复杂起来。很多情况下（像ListView、GridView或ViewPager等组件），屏幕上已显示的图片和即将滑动到当前屏幕上的图片数量基本上是没有限制的。</p>
<p>这些组件通过重用已经移除屏幕的子视图来将降低内存的使用，垃圾回收器也会及时释放那些已经不再使用的已下载的图片，这些都是很好的方法，但是为了保持一个流畅的、快速加载的用户界面，就应该避免当再次回到某个页面时而重新处理图片。内存缓存和磁盘缓存可以帮我们做到这些，它们允许组件快速地重新加载已处理好的图片。</p>
<h4 id="u4F7F_u7528_u5185_u5B58_u7F13_u5B58"><a href="#u4F7F_u7528_u5185_u5B58_u7F13_u5B58" class="headerlink" title="使用内存缓存"></a>使用内存缓存</h4><p>内存缓存允许快速地访问图片，但它以占用App宝贵的内存为代价。LruCache类（API Level 4的Support Library也支持）特别适合来做图片缓存，它使用一个强引用的LinkedHashMap来保存最近使用的对象，并且会在缓存数量超出预设的大小之前移除最近最少使用的对象。</p>
<blockquote>
<p>以前流行的内存缓存方案是使用软引用或弱引用来缓存图片，然而现在不推荐这样做了，因为从Android 2.3(API Level 9)起，垃圾收集器更倾向于先回收软引用或弱引用，这样就使它们变得低效。另外在Android 3.0(API Level 11)之前，图片的像素数据是存储在native memory中的，它以一种不可预测的方式释放，因此可能会导致App超过内存限制甚至崩溃。</p>
</blockquote>
<p>为了给LruCache设置一个合适的大小，以下是应该考虑的一些因素：</p>
<ul>
<li>你的Activity或App的可用内存是多少？</li>
<li>一次展示到屏幕上的图片是多少？有多少图片需要预先准备好以便随时加载到屏幕？</li>
<li>设备的屏幕尺寸和密度是多少？像Galaxy Nexus这样的高分辨率（xhdpi）设备比Nexus S这样分辨率（hdpi）的设备在缓存相同数量的图片时需要更大的缓存空间。</li>
<li>图片的尺寸和配置是怎样的？每张图片会占用多少内存？</li>
<li>图片的访问频率如何？是否有一些图片比另一些访问更加频繁？如果这样的话，或许可以将某些图片一直保存在内存里或者针对不同的图片分组设置不同的LruCache对象。</li>
<li>你能否平衡图片质量和数量之间的关系？有时候存储更多低质量的图片更加有用，当在需要的时候，再通过后台任务下载高质量的图片。</li>
</ul>
<p>这里没有一个具体的大小和计算公式适用于所有的App，你需要分析你的使用情况并得到一个合适的方案。当一个缓存太小时会导致无益的额外的开销，而缓存太大时也可能会引起java.lang.OutOfMemory异常，另外缓存越大，留给App其他部分的内存相应就越小。</p>
<p>这里是一个为图片设置LruCache的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LruCache&lt;String, Bitmap&gt; mMemoryCache;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Get max available VM memory, exceeding this amount will throw an</span></span><br><span class="line">    <span class="comment">// OutOfMemory exception. Stored in kilobytes as LruCache takes an</span></span><br><span class="line">    <span class="comment">// int in its constructor.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxMemory = (<span class="keyword">int</span>) (Runtime.getRuntime().maxMemory() / <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use 1/8th of the available memory for this memory cache.</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> cacheSize = maxMemory / <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    mMemoryCache = <span class="keyword">new</span> LruCache&lt;String, Bitmap&gt;(cacheSize) &#123;</span><br><span class="line">        <span class="annotation">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">sizeOf</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// The cache size will be measured in kilobytes rather than</span></span><br><span class="line">            <span class="comment">// number of items.</span></span><br><span class="line">            <span class="keyword">return</span> bitmap.getByteCount() / <span class="number">1024</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToMemoryCache</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mMemoryCache.put(key, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmapFromMemCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mMemoryCache.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在上述例子中，我们分配了应用内存的1/8作为缓存大小，在一个normal/hdpi的设备上最少也有4MB(32/8)的大小。一个800<em>480分辨率的屏幕上的一个填满图片的GridView大概占用1.5MB（800</em>480*4byte）的内存，因此该Cache至少可以缓存2.5页这样的图片。</p>
</blockquote>
<p>当加载一张图片到ImageView时，首先检查LruCache，如果找到图片，就直接用来更新ImageView，如果没找到就开启一个后台线程来处理：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBitmap</span><span class="params">(<span class="keyword">int</span> resId, ImageView imageView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String imageKey = String.valueOf(resId);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> Bitmap bitmap = getBitmapFromMemCache(imageKey);</span><br><span class="line">    <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mImageView.setImageBitmap(bitmap);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mImageView.setImageResource(R.drawable.image_placeholder);</span><br><span class="line">        BitmapWorkerTask task = <span class="keyword">new</span> BitmapWorkerTask(mImageView);</span><br><span class="line">        task.execute(resId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述线程中，在解码图片之后，也需要把它添加到内存缓存中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Decode image in background.</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(Integer... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Bitmap bitmap = decodeSampledBitmapFromResource(</span><br><span class="line">                getResources(), params[<span class="number">0</span>], <span class="number">100</span>, <span class="number">100</span>));</span><br><span class="line">        addBitmapToMemoryCache(String.valueOf(params[<span class="number">0</span>]), bitmap);</span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="u4F7F_u7528_u78C1_u76D8_u7F13_u5B58"><a href="#u4F7F_u7528_u78C1_u76D8_u7F13_u5B58" class="headerlink" title="使用磁盘缓存"></a>使用磁盘缓存</h4><p>虽然内存缓存在快速访问最近使用的图片时是很有用的，但是你无法保证你所需要的图片就在缓存中，类似GridView这样展示大量数据的组件可以很轻易地就占满内存缓存。你的App也可能被类似电话这样的任务打断，当App被切换到后台后也可能被杀死，内存缓存也可能被销毁，一旦用户回到之前的界面，你的App依然要重新处理每个图片。</p>
<p>磁盘缓存可以用来辅助存储处理过的图片，当内存缓存中图片不可用时，可以从磁盘缓存中查找，从而减少加载次数。当然，从磁盘读取图片要比从内存读取慢并且读取时间是不可预期的，因此需要使用后台线程来读取。</p>
<blockquote>
<p>ContentProvider 可能是一个合适的存储频繁访问的图片的地方，比如在Image Gallery应用中。 </p>
</blockquote>
<p>这里的示例代码是从Android源代码中剥离出来的DiskLruCache，以下是更新后的实例代码，在内存缓存的基础上增加了磁盘缓存：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DiskLruCache mDiskLruCache;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object mDiskCacheLock = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mDiskCacheStarting = <span class="keyword">true</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DISK_CACHE_SIZE = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">10</span>; <span class="comment">// 10MB</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DISK_CACHE_SUBDIR = <span class="string">"thumbnails"</span>;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Initialize memory cache</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Initialize disk cache on background thread</span></span><br><span class="line">    File cacheDir = getDiskCacheDir(<span class="keyword">this</span>, DISK_CACHE_SUBDIR);</span><br><span class="line">    <span class="keyword">new</span> InitDiskCacheTask().execute(cacheDir);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitDiskCacheTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">File</span>, <span class="title">Void</span>, <span class="title">Void</span>&gt; </span>&#123;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Void <span class="title">doInBackground</span><span class="params">(File... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">            File cacheDir = params[<span class="number">0</span>];</span><br><span class="line">            mDiskLruCache = DiskLruCache.open(cacheDir, DISK_CACHE_SIZE);</span><br><span class="line">            mDiskCacheStarting = <span class="keyword">false</span>; <span class="comment">// Finished initialization</span></span><br><span class="line">            mDiskCacheLock.notifyAll(); <span class="comment">// Wake any waiting threads</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span>&lt;<span class="title">Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Decode image in background.</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Bitmap <span class="title">doInBackground</span><span class="params">(Integer... params)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String imageKey = String.valueOf(params[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check disk cache in background thread</span></span><br><span class="line">        Bitmap bitmap = getBitmapFromDiskCache(imageKey);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bitmap == <span class="keyword">null</span>) &#123; <span class="comment">// Not found in disk cache</span></span><br><span class="line">            <span class="comment">// Process as normal</span></span><br><span class="line">            <span class="keyword">final</span> Bitmap bitmap = decodeSampledBitmapFromResource(</span><br><span class="line">                    getResources(), params[<span class="number">0</span>], <span class="number">100</span>, <span class="number">100</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add final bitmap to caches</span></span><br><span class="line">        addBitmapToCache(imageKey, bitmap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> bitmap;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addBitmapToCache</span><span class="params">(String key, Bitmap bitmap)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Add to memory cache as before</span></span><br><span class="line">    <span class="keyword">if</span> (getBitmapFromMemCache(key) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mMemoryCache.put(key, bitmap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Also add to disk cache</span></span><br><span class="line">    <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span> &amp;&amp; mDiskLruCache.get(key) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mDiskLruCache.put(key, bitmap);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bitmap <span class="title">getBitmapFromDiskCache</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mDiskCacheLock) &#123;</span><br><span class="line">        <span class="comment">// Wait while disk cache is started from background thread</span></span><br><span class="line">        <span class="keyword">while</span> (mDiskCacheStarting) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mDiskCacheLock.wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mDiskLruCache != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> mDiskLruCache.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creates a unique subdirectory of the designated app cache directory. Tries to use external</span></span><br><span class="line"><span class="comment">// but if not mounted, falls back on internal storage.</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getDiskCacheDir</span><span class="params">(Context context, String uniqueName)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Check if media is mounted or storage is built-in, if so, try and use external cache dir</span></span><br><span class="line">    <span class="comment">// otherwise use internal cache dir</span></span><br><span class="line">    <span class="keyword">final</span> String cachePath =</span><br><span class="line">            Environment.MEDIA_MOUNTED.equals(Environment.getExternalStorageState()) ||</span><br><span class="line">                    !isExternalStorageRemovable() ? getExternalCacheDir(context).getPath() :</span><br><span class="line">                            context.getCacheDir().getPath();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> File(cachePath + File.separator + uniqueName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>初始化磁盘缓存需要磁盘操作因此它不应在主线程进行，然而这意味着有可能在磁盘缓存尚未初始化之前就有访问操作发生，为了解决这个问题，在上面的实现中，使用一个锁对象来确保只有在磁盘缓存初始化之后才会从磁盘缓存读取数据。</p>
</blockquote>
<p>内存缓存可以直接在UI线程读取，然而磁盘缓存必须在后台线程检查，磁盘操作不应该在UI线程发生。当图片处理完毕后，务必将最终的图片添加到内存缓存和磁盘缓存以备后续使用。</p>
<p>本文译自<a href="https://developer.android.com/training/displaying-bitmaps/cache-bitmap.html" target="_blank" rel="external">官方文档</a>，最初于2015年2月9日发布于个人<a href="http://blog.csdn.net/ahence/article/details/43671737" target="_blank" rel="external">CSDN博客</a>。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/28/在南下的火车上/">在南下的火车上</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-28
        </span>
        
          <div class="post-category">
            
              <a href="/categories/杂谈/">杂谈</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>很久没坐这么长时间的火车了，从沈阳到上海的高铁需要10个半小时。高铁的环境跟多年前拥挤的火车比起来好了太多，因此可以在列车上好好思考。</p>
<p>大概9年前刚上大二坐火车去大学，当时写过一篇文字叫《南下的忧伤》，其中有几句是这样的：</p>
<blockquote>
<p>突然想哭，可是在拥挤的火车上，我的泪始终没有掉下来。</p>
<p>我像一只被邮寄的包裹，从石家庄到北京，从北京到九江，从九江到赣州，我漂泊在各个城市之间。</p>
</blockquote>
<p>写了《南下的忧伤》大概一两年后，再次看到时又补了如下几句：</p>
<blockquote>
<p>后记：今日整理笔记，看到自己的这篇文章，觉得挺好笑的，时过境迁，或许当时只是不愿离开家吧。今日看来，再没什么难过，因为我在为梦而奔波。人的一生本就写满了流浪，这才叫生活。</p>
</blockquote>
<p>是这样的，也许刚上大学那会儿还比较迷茫，不知道梦想究竟在哪里。离开家到千里之外的地方去求学，难免有些难过与失落。</p>
<p>这次因为刚好还有一天假可休，所以故意选择了火车。从沈阳到上海，每到一个站点，看到高铁车厢里的室外温度提示：盘锦27°C、秦皇岛30°C、天津32°C、济南34°C、徐州36°C、南京36°C……不断升高的外部温度告诉我离目的地越来越近。</p>
<p>但此时的心情是豁然开朗的，没有了若干年前的失落与忧郁，因为我已经不在流浪，把家安在了上海，所以人生也有了方向，可能此次唯一遗憾的就是没能回石家庄看看父母。</p>
<p>一路上看农田与村落。</p>
<p>一路上看城市与车站。</p>
<p>一路上看河流与湖泊。</p>
<p>一路上看平原与山岗。</p>
<p>一路上想了很多人。</p>
<p>一路上想了很多事。</p>
<p>突然很珍惜南下火车上的这段时光。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/20/理解Java泛型/">理解Java泛型</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-20
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Java/">Java</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="u6CDB_u578B_u5F15_u5165"><a href="#u6CDB_u578B_u5F15_u5165" class="headerlink" title="泛型引入"></a>泛型引入</h4><p>Java是一种强类型的语言，定义一个变量时需要指明其类型。Object是所有类的基类，在Java 1.5之前，为了让类具有通用性，通常使用Object来实现参数的任意化，如将String、Double等存储为Object类型，这个过程叫做自动装箱或向上转型。但是问题在于取数据时，必须做强制类型转换，将Object向下转型为String或Double等类型。向下转型存在很大的风险，需要事先知道具体的下转型类型是什么，一旦忘记或写错，在运行必然抛出异常，但在编译期间却不易发现，因此存在极大的安全隐患，应该尽量避免使用向下转型。</p>
<p>下面是使用Object的一个示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ObjectFoo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ObjectFoo</span><span class="params">(Object f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getFoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFoo</span><span class="params">(Object foo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体调用如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ObjectFoo strFoo1 = <span class="keyword">new</span> ObjectFoo(<span class="string">"hello Object"</span>);</span><br><span class="line">ObjectFoo intFoo1 = <span class="keyword">new</span> ObjectFoo(<span class="number">100</span>);</span><br><span class="line"><span class="comment">// 此处需要强制类型转换为String</span></span><br><span class="line">String strRst = (String) strFoo1.getFoo();</span><br><span class="line"><span class="comment">// 此处需要强制类型转换为int</span></span><br><span class="line"><span class="keyword">int</span> intRst = (<span class="keyword">int</span>) intFoo1.getFoo();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"strFoo1.getFoo:"</span> + strRst);</span><br><span class="line">System.out.println(<span class="string">"intFoo1.getFoo:"</span> + intRst);</span><br></pre></td></tr></table></figure>
<p>正因为这个过程麻烦且容易出错，在Java 1.5中推出了泛型这个新特性，其本质是参数化类型。泛型在使用时会指明具体的类型，因此不需要向下转型，编译的时候也会检查类型安全，泛型还可以提高代码重用性，概括来说就是简单易用并且安全，泛型可用在类、接口、方法中，分别叫做泛型类、泛型接口和泛型方法，下面会一一介绍。</p>
<h4 id="u6CDB_u578B_u7C7B"><a href="#u6CDB_u578B_u7C7B" class="headerlink" title="泛型类"></a>泛型类</h4><p>依然以上述场景为例，先看一下利用泛型类是如何实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsFoo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericsFoo</span><span class="params">(T f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getFoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFoo</span><span class="params">(T foo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>泛型类的调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用泛型时必须指定具体类型，如String，不再需要类型转换</span></span><br><span class="line">GenericsFoo&lt;String&gt; strFoo2 = <span class="keyword">new</span> GenericsFoo&lt;&gt;(<span class="string">"Hello Generics"</span>);</span><br><span class="line"><span class="comment">// 使用泛型时必须指定具体类型，如Integer，不再需要类型转换</span></span><br><span class="line">GenericsFoo&lt;Integer&gt; intFoo2 = <span class="keyword">new</span> GenericsFoo&lt;&gt;(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"strFoo2.getFoo:"</span> + strFoo2.getFoo());</span><br><span class="line">System.out.println(<span class="string">"intFoo2.getFoo:"</span> + intFoo2.getFoo());</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看到，跟普通的类相比，多出了<code>&lt;T&gt;</code>符号，T是自定义的标识符，也作为参数，用来传递数据类型，称之为类型参数。T可以理解为数据类型的占位符，在运行时会被替换为真正的数据类型，上面示例中T会被替换为String和Integer。</p>
<h4 id="u6CDB_u578B_u89C4_u5219"><a href="#u6CDB_u578B_u89C4_u5219" class="headerlink" title="泛型规则"></a>泛型规则</h4><ol>
<li>泛型类型参数只能是类类型，包括自定义类。</li>
<li>类型参数不一定写为T，实际上可以任意定义。但习惯上使用单个大写字母，并且通常有如下含义：T-Type（表示一般数据类型）、K-Key（表示键）、V-Value（表示值）、N-Number（表示数值类型）、E-Element（集合中的元素，在集合中使用）、？（表示不确定的类型，用作通配符）等等。</li>
<li>泛型的类型参数可以有多个，用逗号隔开，如<code>&lt;K, V&gt;</code>。</li>
<li>泛型的参数类型可以使用extends语句，例如<code>&lt;T extends superclass&gt;</code>，叫做限制泛型。如果有多个类和接口，写法为<code>&lt;T extends SomeClass &amp; interface1 &amp; interface2 &amp; interface3&gt;</code>，但只能存在一个类，因为Java只能继承一个类，多个接口需写在类的后面。</li>
<li>泛型的参数类型可以是通配符类型，例如<code>Class&lt;?&gt; classType = Class.forName(&quot;java.lang.String&quot;)</code>。</li>
</ol>
<h4 id="u6CDB_u578B_u65B9_u6CD5"><a href="#u6CDB_u578B_u65B9_u6CD5" class="headerlink" title="泛型方法"></a>泛型方法</h4><p>使用泛型方法时不必指明参数类型，编译器会根据传递的参数自动查找具体的类型，这一点与泛型类不同。泛型方法与其所在类是不是泛型类没有关系，普通类也可拥有泛型方法，要定义一个泛型方法，只需要将类型参数放在修饰符之后、返回值之前即可。一旦定义了类型参数，就可以在参数列表、方法体及返回值中使用了。</p>
<p>下面代码是在上述泛型类的基础上增加了一个泛型方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsFoo</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T foo;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GenericsFoo</span><span class="params">(T f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = f;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getFoo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFoo</span><span class="params">(T foo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.foo = foo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 泛型方法</span></span><br><span class="line">    <span class="keyword">public</span> &lt;V&gt; <span class="function"><span class="keyword">void</span> <span class="title">getValue</span><span class="params">(V f)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"The value is:"</span> + f);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>泛型方法除了定义不同，调用方法就跟普通方法一样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GenericsFoo&lt;String&gt; strFoo2 = <span class="keyword">new</span> GenericsFoo&lt;&gt;(<span class="string">"Hello"</span>);</span><br><span class="line"></span><br><span class="line">strFoo2.getValue(strFoo2.getFoo());</span><br><span class="line">strFoo2.getValue(<span class="string">"Generics Method"</span>);</span><br><span class="line">strFoo2.getValue(<span class="number">255</span>);</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<blockquote>
<p>The value is:Hello<br>The value is:Generics Method<br>The value is:255</p>
</blockquote>
<h4 id="u6CDB_u578B_u63A5_u53E3"><a href="#u6CDB_u578B_u63A5_u53E3" class="headerlink" title="泛型接口"></a>泛型接口</h4><p>泛型接口跟泛型类定义很像，直接放上示例代码，相信大家都能看懂。</p>
<p>定义泛型接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>泛型接口的实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InfoImp</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Info</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> T var;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InfoImp</span><span class="params">(T var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.var = var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setVar</span><span class="params">(T var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.var = var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">getVar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Info&lt;String&gt; strObj = <span class="keyword">new</span> InfoImp&lt;&gt;(<span class="string">"Hello Generics Interface"</span>);</span><br><span class="line">        System.out.println(<span class="string">"The string value is:"</span> + strObj.getVar());</span><br><span class="line"></span><br><span class="line">        Info&lt;Integer&gt; intObj = <span class="keyword">new</span> InfoImp&lt;&gt;(<span class="number">1024</span>);</span><br><span class="line">        System.out.println(<span class="string">"The integer value is:"</span> + intObj.getVar());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<blockquote>
<p>The string value is:Hello Generics Interface<br>The integer value is:1024</p>
</blockquote>
<h4 id="u9650_u5236_u6CDB_u578B"><a href="#u9650_u5236_u6CDB_u578B" class="headerlink" title="限制泛型"></a>限制泛型</h4><p>上面泛型类的示例中<code>public class GenericsFoo&lt;T&gt;</code> 并没有限制类型参数T的类型，实际上这里相当于Object，可以是任何类型。有时候我们需要对此处的类型做特定限制，这就是限制泛型了，听起来有点抽象，举个例子很容易就明白了。</p>
<p>限制泛型的基本语法为<code>&lt;T extends SuperClass(或Interface)&gt;</code>，这里的extends需要广义理解，接口也是用它，这就表示T的类型只能是该SuperClass的子类或者是任何实现了这个接口的类的类型，这样就对泛型做了限制。</p>
<p>假设定义一个父类Geometry：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Geometry</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">double</span> area;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再定义3个类，其中Circle、Square继承自Geometry，Keyboard没有继承Geometry。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Circle</span> <span class="keyword">extends</span> <span class="title">Geometry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> <span class="keyword">extends</span> <span class="title">Geometry</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Keyboard</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>限制泛型类的定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GenericsRestrict</span>&lt;<span class="title">T</span> <span class="keyword">extends</span> <span class="title">Geometry</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上所示，泛型类型仅能是Geomerty或其子类，其他类型则会报错。</p>
<p>调用测试，如果是限制之外的类型就会报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        GenericsRestrict&lt;Square&gt; square = <span class="keyword">new</span> GenericsRestrict&lt;&gt;();</span><br><span class="line">        GenericsRestrict&lt;Circle&gt; circle = <span class="keyword">new</span> GenericsRestrict&lt;&gt;();</span><br><span class="line">        <span class="comment">// 因为Keyboard没有继承Geometry,下面语句报错</span></span><br><span class="line">        GenericsRestrict&lt;Keyboard&gt; keyboard = <span class="keyword">new</span> GenericsRestrict&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然extends后面可以是接口或类与多个接口，规范及原理相同，这里不再赘述。</p>
<h4 id="u901A_u914D_u7B26_u6CDB_u578B"><a href="#u901A_u914D_u7B26_u6CDB_u578B" class="headerlink" title="通配符泛型"></a>通配符泛型</h4><p>为了解决类型被限制死了而不能动态根据需要来确定的缺点，引入了“通配符泛型”， 如&lt;? extends Collection&gt;，？代表未知类型，这个类型可以是Collection接口的所有实现类。使用通配符有以下两点需要注意：</p>
<ol>
<li>如果只指定了&lt;?&gt;，而没有extends，则可以是任意类型。</li>
<li>使用通配符？不但可以限制类型的上限，还可以限制下限。限制下限使用 super 关键字，例如 &lt;? super Number&gt; 表示只能接受 Number 及其父类，可接受的最低类型为Number。上限限制则是使用上面提到的extends关键字。</li>
</ol>
<h4 id="u6CE8_u610F"><a href="#u6CE8_u610F" class="headerlink" title="注意"></a>注意</h4><p>如果在使用泛型时没有指定具体的数据类型，就会擦除泛型类型，并向上转型为 Object，在获取数据时必须向下强制类型转换，这与不使用泛型是一样的。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/15/Android微信分享闭环研究/">Android微信分享闭环研究</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-15
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="Android_u5FAE_u4FE1_u5206_u4EAB_u95ED_u73AF_u65B9_u6848_u7814_u7A76"><a href="#Android_u5FAE_u4FE1_u5206_u4EAB_u95ED_u73AF_u65B9_u6848_u7814_u7A76" class="headerlink" title="Android微信分享闭环方案研究"></a>Android微信分享闭环方案研究</h4><p>很多时候我们的应用在使用微信分享内容之后，希望其他用户点击该分享内容能够跳转到我们的App，以实现闭环，这样的分享才是最有价值的。这种需求涉及到不同应用之间的交互，虽然微信提供了分享SDK，但仍然有不少限制，现在总结两种在Android平台上初步认为可行的方案：</p>
<ol>
<li>分享网页，从分享的网页跳转回原App。</li>
<li>分享WXAppExtendObject类型的数据，且只能分享给好友，好友从聊天列表点击收到的分享内容可以直接跳转第三方App（前提是好友手机上已安装了该App）。</li>
</ol>
<p>下面来详细说明两个方案，由于是在项目中实测的，为了隐私及行文方便，假设我们的应用的名字为MyApp，效果截图也就不再展示。</p>
<h4 id="u65B9_u6848_u4E00"><a href="#u65B9_u6848_u4E00" class="headerlink" title="方案一"></a>方案一</h4><p>从WebView（该WebView属于另一个App，并非我们自己的App）跳转到MyApp的某个界面（这里以跳转到MyApp的Acticity A为例）。具体的实现逻辑如下：</p>
<p>（1）该WebView显示的网页内容只是一个超链接，自定义了一个scheme=myapp://，后边可以附加一些参数，如果需要从网页向App传值的话，如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">meta</span> <span class="attribute">http-equiv</span>=<span class="value">"Content-Type"</span> <span class="attribute">content</span>=<span class="value">"text/html; charset=UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">title</span>&gt;</span>This is title<span class="tag">&lt;/<span class="title">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">a</span> <span class="attribute">href</span>=<span class="value">'myapp://id=909624'</span>&gt;</span>Jump to MyApp<span class="tag">&lt;/<span class="title">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>该网页在WebView打开后就是一个简单的超链接，截图不再附。</p>
<p>（2）MyApp中的Activity A需要配置特定的infliter，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">"myapp"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.VIEW"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">category</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.category.DEFAULT"</span> /&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="title">category</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.category.BROWSABLE"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>（3）当在WebView上点击上述自定义的超链接时就可以打开MyApp的A界面，所传递的参数也可以在所跳转到的Activity中获取，方法如下：</p>
<p>getIntent().getScheme();//获得Scheme名称  </p>
<p>getIntent().getDataString();//获得Uri全部路径，根据自定义的格式解析字符串即可获取我们上面附加的参数。</p>
<h5 id="u53EF_u884C_u7684_u5B9E_u65BD_u65B9_u6848"><a href="#u53EF_u884C_u7684_u5B9E_u65BD_u65B9_u6848" class="headerlink" title="可行的实施方案"></a>可行的实施方案</h5><p>MyApp中调用微信分享分享网页内容，只需要在网页中嵌入跟Android客户端约定好的超链接协议scheme，那么点击时就可以跳转到MyApp。</p>
<p>问题1：如果用户安装了MyApp，就可以点击网页跳转，如果没有安装MyApp的话，WebView就会提示找不到该页面。制作网页时可以在网页中做检测，没安装MyApp的话，页面就重定向到应用的下载页面。</p>
<p>问题2：在普通App的WebView中和浏览器中上述机制是可以的，但是在微信的WebView是不可以点击直接跳转我们的应用的，可能是微信做了某些过滤，且仅仅支持跟微信有深度合作的应用的跳转，如大众点评是可以的。针对这种情况，我们可以引导用户使用浏览器打开所分享的网页，然后点击就可以跳转应用了。</p>
<h4 id="u65B9_u6848_u4E8C"><a href="#u65B9_u6848_u4E8C" class="headerlink" title="方案二"></a>方案二</h4><p>使用微信SDK分享WXAppExtendObject数据给好友，好友点击跳转MyApp的某个页面（需要在分享时传递构造跳转Intent的参数）。具体逻辑如下：</p>
<ol>
<li><p>该类型的分享（具体请参考微信分享SDK）可以带几个参数，参数中必须附带一些构造跳转Intent的数据。</p>
</li>
<li><p>好友点击分享的内容，回调IWXAPIEventHandler接口的类的onReq方法，具体为</p>
<p>ConstantsAPI.COMMAND_SHOWMESSAGE_FROM_WX:这种情况才会调用，此时可以取出分享时附带在参数中的一些数据，构造一个跳转Intent,调用startActivity(intent) 来打开MyApp。</p>
</li>
</ol>
<p>由于是项目实测，这种实现方式的截图也就不传了。</p>
<p>问题1：该分享方式只能分享给好友，不能分享到朋友圈。</p>
<p>问题2：如果好友没安装MyApp，点击微信中好友分享过来的消息后无反应，无法提醒“未安装MyApp，请下载”之类的语句，因为这些逻辑要实现的话本身就是在MyApp里面写的，原本没装的话根本无法检测。</p>
<p>问题3：WXAppExtendObject类型的分享，数据有大小限制，其中extInfo(String)限制2KB；fileData(byte[])供第三方使用的文件二进制数据，最大10M；filePath:(String)Local directory of the file provided for applications，本身长度最大10KB,文件大小同上，不超过10M。</p>
<p>以上就是Android平台好友点击微信分享的内容后跳转来源App的两种实现方案，各有优点和局限性，请根据自身业务需求选择合适的分享方式，由于未能附截图说明，如有哪里表述不清楚的，欢迎留言讨论。</p>
<p>本文最初于2014-09-03发布于个人<a href="http://blog.csdn.net/ahence/article/details/39030847" target="_blank" rel="external">CSDN博客</a>。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/15/非微信内置浏览器中的网页调起微信支付的方案研究/">非微信内置浏览器中的网页调起微信支付的方案研究</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-15
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h3 id="u95EE_u9898_u6765_u6E90"><a href="#u95EE_u9898_u6765_u6E90" class="headerlink" title="问题来源"></a>问题来源</h3><p>之前在app中集成过微信支付，当时还写了一篇<a href="http://blog.csdn.net/ahence/article/details/50173621" target="_blank" rel="external">扫坑贴</a>，此种微信支付方式为app支付，即在我们自己的应用中嵌入微信支付SDK，由Native代码调起微信支付。</p>
<p>后来由于业务需要在我们app的WebView中打开第三方店铺的网页，在第三方网页中有微信支付按钮，测试反馈说ios可以调起微信支付，而android不可以。后来网上看到说微信内置Webview和京东的网页也可以调起微信支付，微信自己没什么奇怪的，而京东可以的话，如果它跟微信没什么合作协议的话，那么其他app应该也可以在网页中调用微信支付。</p>
<h3 id="u63A2_u7D22"><a href="#u63A2_u7D22" class="headerlink" title="探索"></a>探索</h3><p>由于ios可以支持，因此找ios同事测试了一下，发现ios内置浏览器中只要输入相关协议都可以调起相关app的，比如：</p>
<ol>
<li>输入weixin://  可以调起微信</li>
<li>输入alipay://  可以调起支付宝</li>
</ol>
<p>这样就不难解释为什么ios的webview中第三方网页可以调起微信支付了，但android在浏览器中输入上述协议，没有任何响应。因此本文主要探讨是基于android平台的。</p>
<p>后来终于找到<a href="https://pay.weixin.qq.com/wiki/doc/api/wap.php?chapter=15_1" target="_blank" rel="external">微信支付|商户平台开发者文档</a>，作为客户端开发者，是不会想到这个开发文档的，当时集成app支付的时候所查阅的文档也未提到H5支付的方式。在文档的使用场景介绍中有这么一段：</p>
<blockquote>
<p>H5支付是基于公众号基础开发的一种非微信内浏览器支付方式（需要单独申请支付权限），可以满足在微信外的手机H5页面进行微信支付的需求。同时，由于H5链接传播十分方便、来源不易追踪，商户需要特别注意做好防钓鱼、防刷单的处理，控制风险。</p>
</blockquote>
<p>由此看来，确实官方是支持在非微信内置浏览器中调起微信支付的。</p>
<p>在文档中，微信给了一个官方的测试链接：<a href="http://wxpay.weixin.qq.com/pub_v2/pay/wap.v2.php，在手机浏览器中打开该页面，点击“立即购买”，就可以调起微信支付，我测试了Nexus手机的Chorme浏览器和Sony手机的自带浏览器，均可以。具体效果如下图：" target="_blank" rel="external">http://wxpay.weixin.qq.com/pub_v2/pay/wap.v2.php，在手机浏览器中打开该页面，点击“立即购买”，就可以调起微信支付，我测试了Nexus手机的Chorme浏览器和Sony手机的自带浏览器，均可以。具体效果如下图：</a></p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/c1.jpg" alt="这里写图片描述"><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/c2.jpg" alt="这里写图片描述"></p>
<p>通过查看网页源代码，发现“立即购买”是一个按钮，其连接点击协议是这样的：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">href="weixin://wap/pay?appid%3Dwx2421b1c4370ec43b%26noncestr%3D3e84679af4efab5f32ee9ea01b2ec290%26package%3DWAP%26prepayid%3Dwx20160504154919fdacd7bc0d0127918780%26timestamp%3D1462348159%26sign%3DC40DC4BB970049D6830BA567189B463B"</span><br></pre></td></tr></table></figure>
<p>瞬间觉得非常熟悉，以前集成app支付的关键代码是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">IWXAPI api;</span><br><span class="line">PayReq request = <span class="keyword">new</span> PayReq();</span><br><span class="line">request.appId = <span class="string">"wxd930ea5d5a258f4f"</span>;</span><br><span class="line">request.partnerId = <span class="string">"1900000109"</span>;</span><br><span class="line">request.prepayId= <span class="string">"1101000000140415649af9fc314aa427"</span>,;</span><br><span class="line">request.packageValue = <span class="string">"Sign=WXPay"</span>;</span><br><span class="line">request.nonceStr= <span class="string">"1101000000140429eb40476f8896f4c9"</span>;</span><br><span class="line">request.timeStamp= <span class="string">"1398746574"</span>;</span><br><span class="line">request.sign= <span class="string">"7FFECB600D7157C5AA49810D2D8F28BC2811827B"</span>;</span><br><span class="line">api.sendReq(req);</span><br></pre></td></tr></table></figure>
<p>上述a链接里的协议就是app支付里面的各种参数，因此可以得到结论，weixin://wap/pay是微信定义的一种支付协议，用于网页端支付，微信app必定设置了名为weixin://的scheme，因此可以在网页上唤起微信app,在通过约定的参数名称，获取各种参数，从而可以完成支付，具体机制跟app支付是相同的。至于上面一系列参数，是第三方网页端跟微信那边获取的，均由第三方服务端处理，客户端不必关心。</p>
<p>知道了以上原理，就该讨论解决方案了，下面有几种可行的方案。</p>
<h3 id="u89E3_u51B3_u65B9_u68481"><a href="#u89E3_u51B3_u65B9_u68481" class="headerlink" title="解决方案1"></a>解决方案1</h3><p>上面可知，微信的H5支付协议可以在浏览器中调起微信，这也是最简单的方案。如果我们的app打开第三方网页用的是手机浏览器的话，就不用做什么，直接可以调起微信支付了。按微信文档所说，应该大部分浏览器都支持，我只是简单测试了两款。</p>
<h3 id="u89E3_u51B3_u65B9_u68482"><a href="#u89E3_u51B3_u65B9_u68482" class="headerlink" title="解决方案2"></a>解决方案2</h3><p>第一种方案固然简单，但事实上我们往往使用WebView来打开第三方网页，而不是手机浏览器，因此如何让WebView也支持调起微信支付才是核心问题。经过测试发现，原生WebView是可以唤起微信支付的，核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView = <span class="keyword">new</span> WebView(<span class="keyword">this</span>);</span><br><span class="line">webView.getSettings().setJavaScriptEnabled(<span class="keyword">true</span>);  </span><br><span class="line">webView.loadUrl(<span class="string">"http://wxpay.weixin.qq.com/pub_v2/pay/wap.v2.php"</span>);</span><br></pre></td></tr></table></figure>
<p>对，就这样简单就OK了。</p>
<p>然而往往我们的app中使用自定义的WebView，经测试发现如果为WebView设置了WebViewClient，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;</span><br><span class="line">    <span class="comment">// some logic</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么就不能唤起微信支付了，errorCode返回-10，提示“<strong>不支持该协议</strong>”。联系到可以在浏览器中唤起微信支付，因此我的解决方案如下,经测试是可以的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">  webView.setWebViewClient(<span class="keyword">new</span> WebViewClient() &#123;  </span><br><span class="line">      <span class="annotation">@Override</span>  </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(WebView view, String url)</span> </span>&#123;  </span><br><span class="line">      	<span class="comment">// 如下方案可在非微信内部WebView的H5页面中调出微信支付</span></span><br><span class="line">      	<span class="keyword">if</span> (url.startsWith(<span class="string">"weixin://wap/pay?"</span>)) &#123;</span><br><span class="line">		Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">		intent.setAction(Intent.ACTION_VIEW);</span><br><span class="line">		intent.setData(Uri.parse(url));</span><br><span class="line">		startActivity(intent);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      	<span class="keyword">return</span> <span class="keyword">super</span>.shouldOverrideUrlLoading(view, url);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPageFinished</span><span class="params">(WebView view, String url)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// TODO Auto-generated method stub				</span></span><br><span class="line">	<span class="keyword">super</span>.onPageFinished(view, url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceivedError</span><span class="params">(WebView view, <span class="keyword">int</span> errorCode,</span><br><span class="line">		String description, String failingUrl)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// TODO Auto-generated method stub				</span></span><br><span class="line">	<span class="keyword">super</span>.onReceivedError(view, errorCode, description, failingUrl);</span><br><span class="line">&#125;            </span><br><span class="line">      </span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>
<p>第二种解决方案的效果图如下，注意使用了WebView打开的网页：</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/s1.jpg" alt="这里写图片描述"><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/s2.jpg" alt="这里写图片描述"></p>
<h3 id="u89E3_u51B3_u65B9_u68483"><a href="#u89E3_u51B3_u65B9_u68483" class="headerlink" title="解决方案3"></a>解决方案3</h3><p>跟前两种方案相比，第三种就算直接暴力了。结合之前嵌入SDK的app支付方式，我们可以在WebView里拦截H5的支付协议，从上述协议中取出各个参数，完全可以走微信APP支付的方式了。可以发现H5的支付协议中唯独少了partnerId，partnerId指商户ID，在注册微信支付时都会有。至于为什么没有商户id，猜测一是为了安全，另外第三方自家的网页，当然已知partnerId了（如京东的网页，京东在微信的商户id当然知道的），就没必要放到协议中去。</p>
<p>如果我们的app知道第三方的partnerId的话，这样就能拿到所有参数，理论上完全可以转走app支付的方式，具体我没有测试，有兴趣的可以试一下。</p>
<p>本文最初于2016-05-04发布于个人<a href="http://blog.csdn.net/ahence/article/details/51317814" target="_blank" rel="external">CSDN博客</a>。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/15/Android微信支付彻底扫坑/">Android微信支付彻底扫坑</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-15
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h3 id="Android_u5BA2_u6237_u7AEF_u96C6_u6210_u5FAE_u4FE1_u652F_u4ED8"><a href="#Android_u5BA2_u6237_u7AEF_u96C6_u6210_u5FAE_u4FE1_u652F_u4ED8" class="headerlink" title="Android客户端集成微信支付"></a>Android客户端集成微信支付</h3><p>由于公司运营需要，Android客户端要增加微信支付。在看了几遍官方文档之后，加上之前有集成微信分享的经验，所以很快就把调用微信支付的代码写好了，待微信支付相关接口完成后联调时，才发现山高路远坑深啊！从下午2点半开始调试，一直折腾到快6点，那个微信支付界面才“千呼万唤始出来”，更坑爹的是，压根儿就不是我客户端的问题，而是后台接口那边sign生成时出了问题。在解决问题的过程中，看到网上太多关于微信支付各种问题的帖子，但遗憾的是并没有找到真正有效的解决方案，所以就来彻底扫一下Android集成微信支付中的坑。</p>
<h3 id="u4E3B_u8981_u903B_u8F91"><a href="#u4E3B_u8981_u903B_u8F91" class="headerlink" title="主要逻辑"></a>主要逻辑</h3><p>首先讲一下我们的逻辑，如<a href="https://pay.weixin.qq.com/wiki/doc/api/app.php?chapter=8_5" target="_blank" rel="external">微信支付开发文档</a>中Android部分描述的那样，由服务器端请求微信支付平台生成prepayid，大家一般也都是这么做的，发现网上有一部分人从服务器端拿到prepayid后，在客户端自己拼字符串参数，然后调用算法生成sign，这样是可以，但是安全性不好，而且客户端逻辑也变复杂了，估计大家是按照官方demo写的，至于其demo暂时就不评价了，下面会提及。我们的做法是所有的必要参数，如partnerId、prapayId、packageValue、nonceStr、timeStamp、sign等都是由服务器端生成，至于appId自己写在客户端也行，服务器端传过来也行，因为之前微信分享appId是写在客户端了，因此微信支付就没让服务器端返回appId这个参数。其实微信支付官方文档也是这样建议的,原文为“商户服务器生成支付订单，先调用统一下单API(详见第7节)生成预付单，获取到prepay_id后将参数再次签名传输给APP发起支付”。App端拿到上述6个主要参数后，加上appId，一共7个，就可以调起支付了。</p>
<p>如上所述，客户端的逻辑就这么简单，所以当调试时竟然调不出支付界面，真觉得不可思议。我遇到的问题是这样的：当发起支付时调不出微信支付界面，直接响应<code>WXPayEntryActivity</code>中的<code>onResp</code>回调，并且<code>errCode</code>始终返回-1。如果微信未登录，则会调起登陆界面，登陆完成后还是调不起来，<code>errCode</code>依然返回-1。</p>
<p>我们客户端的实现逻辑基本跟官方文档一致（注意官方文档有个书写错误，在调用支付部分代码最后一行的参数中，<code>request</code>写成了<code>req</code>，后面也会提到），主要核心代码如下：</p>
<p>1.首先注册，其中api为IWXAPI的实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">api = WXAPIFactory.createWXAPI(context, APP_ID, <span class="keyword">false</span>);  </span><br><span class="line">api.registerApp(APP_ID);</span><br></pre></td></tr></table></figure>
<p>2.从服务端拿到上述必要参数后，调支付即可，其中<code>params</code>是自定义的用来保存从服务端获取的所有的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (api != <span class="keyword">null</span>) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (isWXAppInstalled()) &#123;  </span><br><span class="line">        PayReq req = <span class="keyword">new</span> PayReq();  </span><br><span class="line">        req.appId = APP_ID;  </span><br><span class="line">        req.partnerId = params.getPartnerId();  </span><br><span class="line">        req.prepayId = params.getPrepayId();  </span><br><span class="line">        req.packageValue = params.getPackageValue();  </span><br><span class="line">        req.nonceStr = params.getNonceStr();  </span><br><span class="line">        req.timeStamp = params.getTimeStamp();  </span><br><span class="line">        req.sign = params.getSign();  </span><br><span class="line"></span><br><span class="line">        api.sendReq(req);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.<code>WXPayEntryActivity</code>这个回调界面实际上不会影响前面的调起支付的逻辑，写过微信分享的应该知道，这个Activity一定要放到“App包名.wxapi”的package中,否则无法响应回调，当然别忘了在<code>AndroidManifest.xml</code>中注册。微信分享的回调<code>WXEntryActivity</code>也是这样的，放在同一个包即可。</p>
<h3 id="u5751_u5751_u5751"><a href="#u5751_u5751_u5751" class="headerlink" title="坑坑坑"></a>坑坑坑</h3><p>Android客户端的核心逻辑就是以上这些，下面来一一列举微信支付中的坑，或者叫注意点吧，有些是我知道因此没有亲自踩上去的也一并列出。</p>
<p>1.首先如果要使用微信支付的话，必须先到<a href="https://open.weixin.qq.com/" target="_blank" rel="external">微信开放平台</a>注册应用，注册时需要填应用的包名和签名，注意这里的签名是App正式版的签名，可以找一个已上线的包或打一个正式包，使用微信提供的工具来获取(<a href="https://open.weixin.qq.com/zh_CN/htmledition/res/dev/download/sdk/Gen_Signature_Android.apk" target="_blank" rel="external">签名工具下载地址</a>)，获取后填上即可。待审核通过后，会得到一个AppID和AppSecret，AppID分享和支付都要用到，AppSecret没什么实际用途，此时微信分享能力是直接拥有的，支付能力还要额外申请，其中涉及到财务信息等，最好让公司财务部门去申请，申请成功后会拿到一个商户id，后面生成sign时会用到。只有所有审核都通过后，才可调用微信支付功能，这点是前提。</p>
<p>2.微信分享和微信支付SDK是同一个架包，名为libammsdk.jar。</p>
<p>3.官方开发文档中有一处错误，需要注意下，示例代码的最后一行参数req应该为request，照搬代码的估计IDE也不会放过你，哈哈。</p>
<p>4.测试微信支付时，务必对自己的App做正式签名，因为一开始就在微信平台注册过签名信息，微信SDK会做校验，只有这样才能调起微信分享和微信支付，直接debug版的包则绝对调不起来，这点务必注意，很多人是跌在这里了！当初做微信分享曾遇到过，所以会很留心，也因为如此，如果微信分享能调起来，微信支付不行，那就不要怀疑签名问题了。</p>
<p>5.还是签名，网上有人说要注意大小写，这点其实是不必的。在微信开放平台看到审核通过的App的签名是大写的，而用微信签名获取工具获得的则显示小写，这个没关系，不要贸然改动平台注册信息，不然又可能导致漫长的审核等待，上面也说了，微信分享如可以，那就不是签名问题。</p>
<p>6.来说下官方demo，这东西害人不浅啊！很多人参考其写法，如生成sign放在客户端啊，调支付的<code>Activity</code>添加<code>intent-filter</code>啊，最主要的还是签名问题。其实客户端逻辑很简单，直接上手集成即可，demo看看逻辑就行，照抄小心掉坑里。</p>
<p>7.网上有人说需要给调用支付的<code>Activity</code>配置如下<code>intent-filter</code>（见下面的配置），可能也是被demo误导了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">intent-filter</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="title">action</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.action.VIEW"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="title">category</span> <span class="attribute">android:name</span>=<span class="value">"android.intent.category.DEFAULT"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="title">data</span> <span class="attribute">android:scheme</span>=<span class="value">"appid"</span>/&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="title">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从逻辑上来看，根本不会跳这个界面啊，所以当然是非必需的。</p>
<p>8.对于<code>errCode</code>返回-1，有人说清除微信缓存或切换账户就好了，这种解决方案治标不治本啊，根本不能算解决方案。虽然我没遇到能用这方法解决的问题，但目测是签名的问题，建议还得找到真正的问题所在。</p>
<p>9.生成sign时特别需要注意，首先将key-value键值对拼成字符串，注意key都要小写，如appid,noncestr,package,partnerid,prepayid,timestamp,key,并且名字得按上述名称，我们遇到的错误就是因为partnerid写成了partnerId,prepayid写成了PrepayId，当然我们是在服务端写的，如果在客户端生成sign的话，也需要注意大小写及名称，详细信息请参考官方文档。还有这里的key并非AppID或AppSectet，而是在商户平台设置的，官方描述为“key设置路径：<a href="/pay.weixin.qq.com">微信商户平台</a>–&gt;账户设置–&gt;API安全–&gt;密钥设置”。对于noncestr，申请prepayid和生成sign时两次需要用到，由于iOS同事看到相关文章说noncestr前后需要一致，因此这个随机字符串我们是设置成一样的了，这样做Android平台也是OK的，不过个人感觉这里可以不一致，由于这个逻辑在服务器端，我并没有验证，方便的同学可以验证下。</p>
<p>10.<code>req.packageValue=”Sign=WXPay”</code>，一般都是这样写死这个参数值。也有人说写成<code>req.packageValue=”prepay_id=” + prepayid</code>，经测试Android两种写法都是可以调起微信支付的，至少最新版本SDK是可以的，以后则不清楚，官方也建议写Sign=WXPay，据说iOS只支持这种写法。</p>
<p>11.对于IWXAPI实例的创建，官方代码为： </p>
<p><code>IWXAPI api = WXAPIFactory.createWXAPI(context, null)</code>;</p>
<p>这样写就可以，如果调用另一个工厂方法：</p>
<p><code>IWXAPI api = WXAPIFactory.createWXAPI(context, APP_ID, false)</code>;</p>
<p>也是OK的，我都测试过，总之这里不是问题的根源。</p>
<p>不得不再次吐槽一下Android微信支付，支付宝之类的支付集成是很简单的，微信支付却花了几个小时才搞定，上面罗列了一系列注意事项，都是前人踩过的坑，希望大家看到这篇文章后，可以用20分钟搞定微信支付，如果还有问题，欢迎回复探讨。</p>
<p>本文最初于2015-12-04发布于个人<a href="http://blog.csdn.net/ahence/article/details/50173621" target="_blank" rel="external">CSDN博客</a>。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/14/招聘面试感想/">招聘面试感想</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-14
        </span>
        
          <div class="post-category">
            
              <a href="/categories/杂谈/">杂谈</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <p>前段时间我们需要招聘一名高级Android工程师，招聘信息发出后陆续收到一些简历，有过招聘经验的应该知道，想招到一个合适的人并不容易，期间看了HR推过来的很多简历，也面试了很多应聘者，有些感想想跟大家分享，大概会从以下几个角度谈起。</p>
<h4 id="u7B80_u5386_u672C_u8EAB"><a href="#u7B80_u5386_u672C_u8EAB" class="headerlink" title="简历本身"></a>简历本身</h4><p>那段时间，几乎每天HR都会往我的邮箱推送一些简历，但是想从中发现一两份吸引眼球的并不容易，那种感觉就像沙里淘金。我个人看来主要问题如下：</p>
<ol>
<li>有些简历是从51job之类的网站过来的，而且是使用此类招聘网站的简历模板。这类简历看起来真的是比较low，而且它们提供的模板并不能完全展示某些应该在简历里表现出来的东西。建议自己定制一份简历，或者至少使用拉勾、内推等IT行业较为专业的招聘网站。</li>
<li>有些简历的格式是.doc，打开之后排版居然乱掉了，这种简历也让人没有味口继续看下去。建议将简历以PDF格式投出去，当然你自己可以使用Word编辑修改。</li>
<li>有这样一份简历，内容很不错，应聘者项目经验也比较多，但不幸的是在这份短短的简历中居然出现了3个错别字，如“Glide”写成了“Guide”,还把自己的一个项目名称写的前后不一致。也许有些人不太在乎这个，但我没法容忍，别说3个错别字，哪怕一个错别字也不行。简历作为个人的门面，写好之后难道不要字斟句酌、多读几遍看看吗？难道发现不了错别字吗？简历上都允许出现错字的人，你怎能对他的代码放心？哪怕他技术再牛，我们也不敢招。</li>
<li>关于简历内容，有的言简意赅、突出重点；而有的则长篇大论、内容空洞。所以写简历也是一种技巧，网上也有相当多的行业简历模板。想起当时写硕士毕业论文时问导师应该写多少页为宜，老师说只要是干货哪怕一页纸几页纸就够了。希望大家明白一个道理，简历尽量精简，内容应当为所应聘的职位服务，去掉风马牛不相及的东西。</li>
</ol>
<h4 id="u5E94_u8058_u8005_u6280_u80FD_u4E0E_u7D20_u517B"><a href="#u5E94_u8058_u8005_u6280_u80FD_u4E0E_u7D20_u517B" class="headerlink" title="应聘者技能与素养"></a>应聘者技能与素养</h4><p>应聘者的技术能力与职业素养应该是最核心的因素了，这决定招聘者是否决定录用。我遇到的可以总结为以下几种情况：</p>
<ol>
<li>应聘者技术能力优秀，职业素养却太差。有一位应聘者是这样的，技术面试感觉不错，后面几轮面试也都挺好，最后发了offer，该应聘者也答应入职并约定好了入职时间。就在入职前几天，人事部门都已经发了欢迎邮件并且IT部门连电脑都已经为他配好了，结果倒好，到了入职这天，这哥们儿居然放我们鸽子没来。后来HR电话过去才告诉我们说有新的offer不来了。这种人虽然技术不错，但职业素养真的太低，答应了入职却不来，即便不来也应该提前通知一下吧，不仅影响了我们的研发进度，还耽误了我们的招聘进度。相比之下，另一位应聘者就做的不错，当时一眼就看中他的简历了，HR跟他约好面试时间。到面试那天该应聘者提前通知（本来约的下午面试，上午通知的我们）说已经拿到offer了，面试来不了了，这起码算是一种为人的道德素质吧。</li>
<li>应聘者目前技术能力一般，但学习态度很好，职业素养较高。我还是挺喜欢这样的应聘者的，当时如果不是由于需要高级工程师，我会通过面试，也会给他充足的成长时间。</li>
<li>应聘者技术一般，学习态度不够积极，职业素养也一般。对于此类应聘者我们只好祝福他能找到工作了。</li>
<li>应聘者技术优秀，职业素养较高。这类应聘者当然是最理想的了，大家都会哄抢的，也愿大家都成为这样的人。</li>
</ol>
<h4 id="u9762_u8BD5_u5B98"><a href="#u9762_u8BD5_u5B98" class="headerlink" title="面试官"></a>面试官</h4><p>作为面试者，我大概把握以下几个原则：</p>
<ol>
<li>提问不局限于简历本身。可想而知，一般的应聘者或者面霸都会针对自己简历上涉及到问题有所准备，所以提问不能局限于简历本身或表面，需要往深度和广度扩展，不能有固定套路，以无招胜有招，这样才能真正了解应聘者的能力。</li>
<li>不问智力问题、脑筋急转弯。就我个人而言，我觉得此类问题没有任何意义，技术招聘又不是国考，想不通为何有些公司总喜欢问这些。对，我相信一定会有智力超群的人回答上来，但大部分人除非预先将智力问答的书背熟了或者以前遇到过，否则都不会回答的太好。而这些智力问题在实际研发中有什么帮助呢？真正遇到之后完全可以Google，几分钟就搞定。我觉得我们更需要解决分析问题的能力和思路，而非智力问答。</li>
<li>不需要应聘者全部回答正确。没有人所有的知识点都精通，闻道有先后，术业有专攻就是这个道理。所以不要期望所有应聘者可以回答正确所有的问题，不会很正常，可以去学习。我们作为面试官需要把握一个水平尺度，哪些是必须应该知道的，哪些是可以知道的，哪些是不需要知道的。</li>
<li>注重应聘者知识面的广度、深度及学习能力。虽然我们是招Android工程师，但是如果你懂一些iOS、Web或后台开发知识，那么一定会为你加分。但是我不喜欢啥都懂一点点，但又没有一项深入研究的人。如果我们不能成为全栈工程师，那么希望你最好专注一门技术，其他技术只是锦上添花。此外我很看重一个人的学习能力，面试时我肯定会问应聘者平时是如何学习技术的，哪些途径、什么方法。在技术领域，需要时刻保持学习的态度，而如何学习也是重中之重，不同的学习方法很可能导致收获大不相同。</li>
<li>面试应聘者时我喜欢聊天的氛围，而不要紧张的问答。一开始我都会跟应聘者说随便聊聊，希望大家能放轻松，其实本来就是聊天交流，互相探讨，互相学习的过程。</li>
</ol>
<p>暂时想到这些，欢迎大家跟我交流相关心得，也祝大家都有一个称心的工作。</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2016/07/06/Web-瓦片-地图的工作原理/">Web(瓦片)地图的工作原理</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2016-07-06
        </span>
        
          <div class="post-category">
            
              <a href="/categories/GIS/">GIS</a>
            
          </div>
        
        
      </div>
    </header>

    
    

    <div class="post-content">
      
        
        

        
          <h4 id="u8BD1_u8005_u6309"><a href="#u8BD1_u8005_u6309" class="headerlink" title="译者按"></a>译者按</h4><p>在看MapBox Guides文档时，看到这篇 How do web maps work?，这篇文档通俗易懂地阐述了Web地图是如何工作的，其实更偏向讲瓦片地图的工作原理，鉴于之前很多人不了解地图切片的原理，因此简单翻译一下，由于源自MapBox文档，文中免不了涉及MapBox的相关术语，但不会影响我们的理解。</p>
<h4 id="u524D_u8A00"><a href="#u524D_u8A00" class="headerlink" title="前言"></a>前言</h4><p>在MapBox上打开的Web地图或在你自己的网站上嵌入的Web地图，其实是由很多部件共同工作的结果，包括MapBox地图服务器，遍布世界各地的分布式系统以及在你的浏览器中运行的客户端代码等。</p>
<p>这篇指南文档将向你介绍单幅的瓦片地图是如何在一起工作并生成Web地图的。</p>
<h4 id="u8FDE_u7EED_u7684_u7A7A_u95F4_u548C_u7EC6_u8282"><a href="#u8FDE_u7EED_u7684_u7A7A_u95F4_u548C_u7EC6_u8282" class="headerlink" title="连续的空间和细节"></a>连续的空间和细节</h4><p>Web地图现在非常普遍，以至于人们经常忘记它区别于普通的纸质城市地图、世界地图的优点。当你浏览一个Web地图的时候，就像在一个很大的连续的图片上漫游，你可以通过在地图上平移（移动距离可能会比较远）来自由地查看纽约、巴黎甚至东京。通过放大和缩小Web地图，你会从国家轮廓看到越来越多的细节，如城市街道和建筑物。</p>
<p>Web地图可以在一个连续的空间系统内为你导航，而不是从这个国家直接跳跃到那个州或者某个城市。尽管名字叫做Web地图，但这个概念同样适用于许多移动地图并且在网上有了越来越多的Web地图，这使得纸质地图逐渐孤立。然而，从现在起，我们称这种概念为Web地图。</p>
<h4 id="u74E6_u7247_u5730_u56FE_u548C_u7F29_u653E_u7EA7_u522B"><a href="#u74E6_u7247_u5730_u56FE_u548C_u7F29_u653E_u7EA7_u522B" class="headerlink" title="瓦片地图和缩放级别"></a>瓦片地图和缩放级别</h4><p>一幅精确到街道级别的世界地图图片宽度为数以百万计的像素，由于这些数据太大了，从而导致无法一次下载并且在内存里也无法一次都hold住。实际上，Web地图由许多小的正方形的图片组成，这些小图片称作瓦片。瓦片的大小一般为256*256像素，这些瓦片一个挨一个并列放置以组成一张很大的看似无缝的地图。</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/20150304111611472.png" alt=""></p>
<p>如果我们想看到更多的地图细节，如想了解国家轮廓级别的地图与街道级别地图的不同，可以使用不同的缩放级别达到目的。缩放级别越高，显示地图的物理尺寸和细节表现也会相应增加。</p>
<p>为了组织如此多的地图瓦片，Web地图使用了一个简单的坐标系统。每一个瓦片都有一个z坐标来表示其缩放级别，还有一个x坐标和一个y坐标用来表示该瓦片在当前缩放级别下的网格内的位置，如：z/x/y。</p>
<p>第一张瓦片在Web地图系统中的坐标为0/0/0，此时缩放级别为0，只有一张瓦片并覆盖了整个世界的范围。</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/20150304111708852.png" alt=""></p>
<p>当缩放级别为1时，把缩放级别为0时的那张瓦片分割成四个相等的方块，其中坐标为1/0/0和1/1/0的两块覆盖北半球，坐标为1/0/1和1/1/1的两块覆盖南半球。</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/20150304111711454.png" alt=""></p>
<p>每一个缩放级别包含的瓦片数量为4的n次方，其中n为缩放级别。如：</p>
<p>缩放级别0包含1张瓦片；</p>
<p>缩放级别1包含4张瓦片；</p>
<p>缩放级别2包含16张瓦片；</p>
<p>依此类推。</p>
<p>由于瓦片数量是随缩放级别按指数增长的，因此每提高一个缩放级别会增加大量的地图细节，同时为了应付越来越多的瓦片，对带宽和存储空间的需求也会相应增加。</p>
<p>例如，一张缩放级别为15的地图，精确到可以看到城市建筑，大约需要11亿张瓦片才能覆盖整个世界，而缩放级别为17时，仅仅是增加了两个缩放级别，同样覆盖全世界却需要170亿张瓦片。</p>
<h4 id="u4E3A_u4EC0_u4E48_u8981_u4F7F_u7528_u74E6_u7247_u5730_u56FE"><a href="#u4E3A_u4EC0_u4E48_u8981_u4F7F_u7528_u74E6_u7247_u5730_u56FE" class="headerlink" title="为什么要使用瓦片地图"></a>为什么要使用瓦片地图</h4><p>简单来说，因为瓦片地图可以很好的工作，所以Web地图使用瓦片。</p>
<ol>
<li>瓦片地图缓存非常高效。如果你曾查看中央公园的地图而下载过曼哈顿的瓦片，当你需要显示泽西城的地图时，你的浏览器可以使用之前缓存的相同的瓦片，而不是重新再下载一次。</li>
<li>瓦片地图可以渐进加载。中央公园的瓦片会在曼哈顿地图边缘加载之前加载，你可以移动或缩放地图到某一个特定点，即使当前地图的边缘部分还没有加载完成。</li>
<li>瓦片地图简单易用。描述地图瓦片的坐标系统很简单，使得很容易在服务器、网络、桌面或移动设备上实现技术集成。</li>
</ol>
<h4 id="u5730_u56FE_u5BA2_u6237_u7AEF_u4E0E_u74E6_u7247"><a href="#u5730_u56FE_u5BA2_u6237_u7AEF_u4E0E_u74E6_u7247" class="headerlink" title="地图客户端与瓦片"></a>地图客户端与瓦片</h4><p>让我们来展示一下中央公园的地图。因为地图瓦片是在网络上的图片，你需要把如下HTML代码嵌入到你的网页中。</p>
<p><code>&lt;img src=&#39;https://a.tiles.mapbox.com/v4/examples.map-i86l3621/0/0/0.png?access_token=pk.eyJ1IjoidHJpc3RlbiIsImEiOiJuZ2E5MG5BIn0.39lpfFC5Nxyqck1qbTNquQ&#39; /&gt;</code></p>
<p>你将会在浏览器中看到坐标为0/0/0的瓦片。</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/20150304111812353.png" alt=""></p>
<p>你需要进行许多缩放才能定位到中央公园。通过一些HTML、CSS和JavaScript代码，你可以按如下步骤显示中央公园的地图：</p>
<ol>
<li>首先确定能够覆盖曼哈顿且能够详细显示中央公园的瓦片的z/x/y坐标。</li>
<li>在网页中添加一系列<code>&lt;img&gt;</code>标签并使用CSS以便在网格中将它们定位到合适的位置。</li>
<li>为地图添加缩放按钮及拖拽平移等事件的响应处理，然后再次开始这些处理过程。</li>
</ol>
<p>幸运的是，你已不需要再做上面这些，这是地图客户端做的事情。地图客户端通常是一个JavaScript库，这个库可以帮你找到需要显示的瓦片，帮助你从地图服务器下载并将它们显示到地图的合适位置。MapBox JavaScript API就是一种地图客户端，当然你还可以使用其他的地图客户端。</p>
<p>地图客户端需要知道你要显示的中心位置以及缩放级别，你可以输入一个位置的坐标然后MapBox.js就能找到你需要的瓦片。</p>
<p>中央公园的经纬度为40.783和-73.966，且查看该公园的最佳缩放级别为13。我们可以使用<code>setView([40.783, -73.966], 13)</code>方法告诉MapBox.js将中央公园的位置在地图上居中并缩放到13的级别。显示效果如下图：</p>
<p><img src="http://7xq0xd.com1.z0.glb.clouddn.com/imgs/20150304111842740.jpeg" alt=""></p>
<p><a href="https://www.mapbox.com/guides/how-web-maps-work/" target="_blank" rel="external">原文地址</a></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
      <a class="prev" href="/page/2/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text">上一页</span>
      </a>
    
    
      <a class="next" href="/page/4/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">AN</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
