<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="App内存占用优化"/>




  <meta name="keywords" content="内存优化, ASPOOK" />










  <link rel="alternative" href="/default" title="ASPOOK" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="http://aspook.com/2017/01/19/App内存占用优化/"/>


<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />






  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









    <title> App内存占用优化 - ASPOOK </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">ASPOOK</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">ASPOOK</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          App内存占用优化
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2017-01-19
        </span>
        
          <div class="post-category">
            
              <a href="/categories/Android/">Android</a>
            
          </div>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#u4F18_u5316App_u5185_u5B58_u4F7F_u7528"><span class="toc-text">优化App内存使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#u76D1_u63A7_u53EF_u7528_u5185_u5B58_u53CA_u5185_u5B58_u4F7F_u7528_u72B6_u51B5"><span class="toc-text">监控可用内存及内存使用状况</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RAM_u4F7F_u7528_u5206_u6790_u5DE5_u5177"><span class="toc-text">RAM使用分析工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u54CD_u5E94_u56DE_u8C03_u91CA_u653E_u5185_u5B58"><span class="toc-text">响应回调释放内存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u68C0_u6D4B_u5E94_u8BE5_u4F7F_u7528_u591A_u5C11_u5185_u5B58"><span class="toc-text">检测应该使用多少内存</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u4F7F_u7528_u9AD8_u6548_u3001_u5185_u5B58_u5360_u7528_u5C11_u7684_u4EE3_u7801_u7ED3_u6784"><span class="toc-text">使用高效、内存占用少的代码结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#u6709_u8282_u5236_u5730_u4F7F_u7528Service"><span class="toc-text">有节制地使用Service</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4F7F_u7528_u4F18_u5316_u7684_u6570_u636E_u5BB9_u5668"><span class="toc-text">使用优化的数据容器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u8C28_u614E_u4F7F_u7528_u4EE3_u7801_u62BD_u8C61"><span class="toc-text">谨慎使用代码抽象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4F7F_u7528Nano_u7248_u672Cprotobufs_u5E8F_u5217_u5316_u6570_u636E"><span class="toc-text">使用Nano版本protobufs序列化数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u907F_u514D_u5185_u5B58_u6CC4_u9732"><span class="toc-text">避免内存泄露</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#u79FB_u9664_u5185_u5B58_u5BC6_u96C6_u578B_u7684_u8D44_u6E90_u548C_u5E93"><span class="toc-text">移除内存密集型的资源和库</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#u51CF_u5C0FAPK_u5927_u5C0F"><span class="toc-text">减小APK大小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u4F7F_u7528Dagger2_u5B9E_u73B0_u4F9D_u8D56_u6CE8_u5165"><span class="toc-text">使用Dagger2实现依赖注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#u8C28_u614E_u4F7F_u7528_u5916_u90E8Library"><span class="toc-text">谨慎使用外部Library</span></a></li></ol></li></ol></li></ol>
    </div>
  </div>


    <div class="post-content">
      
        <h2 id="u4F18_u5316App_u5185_u5B58_u4F7F_u7528"><a href="#u4F18_u5316App_u5185_u5B58_u4F7F_u7528" class="headerlink" title="优化App内存使用"></a>优化App内存使用</h2><p>RAM（Random-access memory）在任何软件开发中都是非常宝贵的资源，移动操作系统由于其物理内存的局限性更是如此。尽管ART（Android Runtime）与Dalvik虚拟机会执行常规的垃圾回收，但这并不意味着可以忽略App中的内存分配与释放。我们应当避免引起内存泄露，如持有静态成员变量而导致无法释放，应当在应用的生命周期回调中释放掉所有的引用。</p>
<p>本文主要介绍如何减少App中的内存使用。</p>
<h3 id="u76D1_u63A7_u53EF_u7528_u5185_u5B58_u53CA_u5185_u5B58_u4F7F_u7528_u72B6_u51B5"><a href="#u76D1_u63A7_u53EF_u7528_u5185_u5B58_u53CA_u5185_u5B58_u4F7F_u7528_u72B6_u51B5" class="headerlink" title="监控可用内存及内存使用状况"></a>监控可用内存及内存使用状况</h3><p>Android 框架与Android Studio可以帮助我们来分析和调整App的内存使用，其中Android框架提供了一些API来帮助App在运行时动态减少内存占用，Android Studio包括一些工具来查看内存的使用情况。</p>
<h4 id="RAM_u4F7F_u7528_u5206_u6790_u5DE5_u5177"><a href="#RAM_u4F7F_u7528_u5206_u6790_u5DE5_u5177" class="headerlink" title="RAM使用分析工具"></a>RAM使用分析工具</h4><p>在优化内存问题之前，需要先找到这些问题，Android Studio及Android SDK提供了几个工具用来分析App中的内存使用：</p>
<ol>
<li><p>Android Studio中的Memory Monitor</p>
<p>该工具可以显示一个会话过程中的内存分配情况，有一个可视化的图形界面，可以看到Java内存随时间的变化情况以及GC事件。当App运行时，可以启动GC操作并且获取Java Heap的快照。该工具的输出可以帮助我们定位哪里容易导致频繁的垃圾回收，从而导致应用程序变慢。</p>
</li>
<li><p>Android Studio中的Allocation Tracker工具</p>
<p>该工具记录了一个App的内存分配情况并在分析快照中列出了所有分配的对象。可以使用此工具找到分配过多对象的部分代码。</p>
</li>
</ol>
<h4 id="u54CD_u5E94_u56DE_u8C03_u91CA_u653E_u5185_u5B58"><a href="#u54CD_u5E94_u56DE_u8C03_u91CA_u653E_u5185_u5B58" class="headerlink" title="响应回调释放内存"></a>响应回调释放内存</h4><p>不同的Android设备或不同的用户操作会导致不同的内存占用状况，Android系统在遇到内存压力的情况下会发出信号预警，App需要监听这些信号来调整内存的使用。</p>
<p>可以使用<code>ComponentCallbacks2</code> API来监听回调以调整内存使用状态。<code>onTrimMemory()</code>可以允许App监听内存相关的事件，无论App是在前台运行还是在后台运行。下面是一个示例，通过实现Activity的<code>onTrimMemory()</code>方法来监听内存相关的回调。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.ComponentCallbacks2;</span><br><span class="line"><span class="comment">// Other import statements ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title">ComponentCallbacks2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Other activity code ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Release memory when the UI becomes hidden or when system resources become low.</span><br><span class="line">     * <span class="doctag">@param</span> level the memory-related event that was raised.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Determine which lifecycle or system event was raised.</span></span><br><span class="line">        <span class="keyword">switch</span> (level) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_UI_HIDDEN:</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                   Release any UI objects that currently hold memory.</span><br><span class="line"></span><br><span class="line">                   The user interface has moved to the background.</span><br><span class="line">                */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_RUNNING_MODERATE:</span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_RUNNING_LOW:</span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_RUNNING_CRITICAL:</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                   Release any memory that your app doesn't need to run.</span><br><span class="line"></span><br><span class="line">                   The device is running low on memory while the app is running.</span><br><span class="line">                   The event raised indicates the severity of the memory-related event.</span><br><span class="line">                   If the event is TRIM_MEMORY_RUNNING_CRITICAL, then the system will</span><br><span class="line">                   begin killing background processes.</span><br><span class="line">                */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_BACKGROUND:</span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_MODERATE:</span><br><span class="line">            <span class="keyword">case</span> ComponentCallbacks2.TRIM_MEMORY_COMPLETE:</span><br><span class="line"></span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                   Release as much memory as the process can.</span><br><span class="line"></span><br><span class="line">                   The app is on the LRU list and the system is running low on memory.</span><br><span class="line">                   The event raised indicates where the app sits within the LRU list.</span><br><span class="line">                   If the event is TRIM_MEMORY_COMPLETE, the process will be one of</span><br><span class="line">                   the first to be terminated.</span><br><span class="line">                */</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">/*</span><br><span class="line">                  Release any non-critical data structures.</span><br><span class="line"></span><br><span class="line">                  The app received an unrecognized memory level value</span><br><span class="line">                  from the system. Treat this as a generic low-memory message.</span><br><span class="line">                */</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>onTrimMemory()</code>回调是在Android4.0（API Level 14）添加的，对于之前的版本，可以使用<code>onLowMemory()</code>回调替代，它大致相当于<code>TRIM_MEMORY_COMPLETE</code>事件。</p>
<h4 id="u68C0_u6D4B_u5E94_u8BE5_u4F7F_u7528_u591A_u5C11_u5185_u5B58"><a href="#u68C0_u6D4B_u5E94_u8BE5_u4F7F_u7528_u591A_u5C11_u5185_u5B58" class="headerlink" title="检测应该使用多少内存"></a>检测应该使用多少内存</h4><p>Android为了支持多进程，因此为每个App占用的内存做了限制。由于不同设备的RAM大小不同，因此分配给每个App的Heap大小也会有差异。当App已经到达了特定的Heap限制，如果再进行内存分配的话，就会抛出 <code>OutOfMemoryError</code>异常。</p>
<p>为了避免内存溢出，我们可以通过<code>getMemoryInfo()</code>查询当前设备上还有多少可用的内存空间，该方法返回一个<code>ActivityManager.MemoryInfo</code>对象，它包含了设备当前的内存状态，如可用内存、总内存以及内存阈值（当可用内存低于该阈值时，系统就会杀死部分进程）等信息。<code>ActivityManager.MemoryInfo</code>有一个叫做<code>lowMemory</code>的布尔属性，表示设备是否处于低内存状态。</p>
<p>下面是一个使用<code>getMemoryInfo()</code>的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSomethingMemoryIntensive</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before doing something that requires a lot of memory,</span></span><br><span class="line">    <span class="comment">// check to see whether the device is in a low memory state.</span></span><br><span class="line">    ActivityManager.MemoryInfo memoryInfo = getAvailableMemory();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!memoryInfo.lowMemory) &#123;</span><br><span class="line">        <span class="comment">// Do memory intensive work ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get a MemoryInfo object for the device's current memory status.</span></span><br><span class="line"><span class="keyword">private</span> ActivityManager.<span class="function">MemoryInfo <span class="title">getAvailableMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ActivityManager activityManager = (ActivityManager) <span class="keyword">this</span>.getSystemService(ACTIVITY_SERVICE);</span><br><span class="line">    ActivityManager.MemoryInfo memoryInfo = <span class="keyword">new</span> ActivityManager.MemoryInfo();</span><br><span class="line">    activityManager.getMemoryInfo(memoryInfo);</span><br><span class="line">    <span class="keyword">return</span> memoryInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="u4F7F_u7528_u9AD8_u6548_u3001_u5185_u5B58_u5360_u7528_u5C11_u7684_u4EE3_u7801_u7ED3_u6784"><a href="#u4F7F_u7528_u9AD8_u6548_u3001_u5185_u5B58_u5360_u7528_u5C11_u7684_u4EE3_u7801_u7ED3_u6784" class="headerlink" title="使用高效、内存占用少的代码结构"></a>使用高效、内存占用少的代码结构</h3><p>一些Android特性、Java类、代码结构会使用更多的内存，可通过使用更高效的代码结构来节省内存。</p>
<h4 id="u6709_u8282_u5236_u5730_u4F7F_u7528Service"><a href="#u6709_u8282_u5236_u5730_u4F7F_u7528Service" class="headerlink" title="有节制地使用Service"></a>有节制地使用Service</h4><p>让一个不再需要的Service保持运行是Android开发中最糟糕的内存管理错误之一。如果App需要Service来执行后台任务，需要在它完成任务时终止它，否则可能导致内存泄露。</p>
<p>当启动一个Service时，系统会保持该服务所在的进程，这样该服务占用的内存将不能被其他进程使用。同时系统通过LRU Cache缓存的的进程数量也将减少，从而降低进程间切换的效率。当内存紧张或系统无法为当前所运行的Service提供足够的进程时还会发生系统抖动。</p>
<p>应当避免使用持久运行的Service，因为它们对内存有持续的需求，建议使用<code>JobScheduler</code>。</p>
<p>如果必须使用Service，可以使用<code>IntentService</code>来限制其生命周期，<code>IntentService</code>会在处理完任务之后终止。</p>
<h4 id="u4F7F_u7528_u4F18_u5316_u7684_u6570_u636E_u5BB9_u5668"><a href="#u4F7F_u7528_u4F18_u5316_u7684_u6570_u636E_u5BB9_u5668" class="headerlink" title="使用优化的数据容器"></a>使用优化的数据容器</h4><p>一些编程语言提供的类可能并未针对移动设备做优化，例如通用的HashMap实现是比较低效的，因为每一个映射都需要一个单独的Entry对象。</p>
<p>Android框架提供了一些优化过的数据容器，如<code>SparseArray</code>、<code>SparseBooleanArray</code>和<code>LongSparseArray</code>。例如<code>SparseArray</code>更加高效，是因为它避免了对key及一些value的自动装箱操作。</p>
<h4 id="u8C28_u614E_u4F7F_u7528_u4EE3_u7801_u62BD_u8C61"><a href="#u8C28_u614E_u4F7F_u7528_u4EE3_u7801_u62BD_u8C61" class="headerlink" title="谨慎使用代码抽象"></a>谨慎使用代码抽象</h4><p>开发者经使用抽象来简化编程，因为抽象可以提高代码的灵活性，也更方便维护。但是抽象会带来明显的内存消耗：抽象一般来说需要执行更多的代码、需要更多的时间以及RAM空间来将代码映射到内存。所以如果抽象不能带来明显的好处，应当避免使用代码抽象。</p>
<p>例如，枚举占用的内存通常是静态常量的两倍，需要严格避免在Android中使用枚举。</p>
<h4 id="u4F7F_u7528Nano_u7248_u672Cprotobufs_u5E8F_u5217_u5316_u6570_u636E"><a href="#u4F7F_u7528Nano_u7248_u672Cprotobufs_u5E8F_u5217_u5316_u6570_u636E" class="headerlink" title="使用Nano版本protobufs序列化数据"></a>使用Nano版本protobufs序列化数据</h4><p><a href="https://developers.google.cn/protocol-buffers/docs/overview" target="_blank" rel="external">Protocol buffers</a>是Google出品的独立于平台及语言的、可拓展的结构化数据序列化技术，它类似于XML，但更加轻量级、快速、简洁。如果决定使用protobufs来序列化数据，应该在客户端选择使用Nano版本，因为常规版本的protobufs会生成极其冗长的代码，从而导致App端出现各种问题，如内存溢出、APK大小增加、执行速度变慢等。</p>
<p>Nano版本Protobufs的相关参考：<a href="https://android.googlesource.com/platform/external/protobuf/+/master/java/README.txt" target="_blank" rel="external">protobuf readme</a>。</p>
<h4 id="u907F_u514D_u5185_u5B58_u6CC4_u9732"><a href="#u907F_u514D_u5185_u5B58_u6CC4_u9732" class="headerlink" title="避免内存泄露"></a>避免内存泄露</h4><p>垃圾回收通常不会影响应用的性能，但是短时间内的垃圾收集将会占用帧时间，垃圾回收占用的时间越多，用到其他事情上的时间就越少。</p>
<p>通常，内存泄露会导致频繁地垃圾回收事件的发生，在实践中，内存泄露描述了给定时间内分配的临时对象的数量。</p>
<p>例如，可能在for循环中分配多个临时对象，或者在View的<code>onDraw()</code>方法中创建多个Paint、Bitmap对象。上述情况下，App会快速创建大量对象，从而迅速消耗掉新生代中的内存，导致GC的发生。</p>
<p>我们需要找到内存泄露的地方并进行修复，如将实例化操作移出for循环，不要在<code>onDraw()</code>这种频繁调用的方法中创建对象。</p>
<h3 id="u79FB_u9664_u5185_u5B58_u5BC6_u96C6_u578B_u7684_u8D44_u6E90_u548C_u5E93"><a href="#u79FB_u9664_u5185_u5B58_u5BC6_u96C6_u578B_u7684_u8D44_u6E90_u548C_u5E93" class="headerlink" title="移除内存密集型的资源和库"></a>移除内存密集型的资源和库</h3><p>代码中的一些资源及Library可能会在我们不知情的情况下吞噬内存。一个APK中，第三方库或者嵌入的资源会影响到App占用的内存总量。可以通过移除冗余的资源、臃肿的组件及不必要的Library来优化内存消耗。</p>
<h4 id="u51CF_u5C0FAPK_u5927_u5C0F"><a href="#u51CF_u5C0FAPK_u5927_u5C0F" class="headerlink" title="减小APK大小"></a>减小APK大小</h4><p>通过减小APK的大小可以明显减低App对内存的占用。Bitmap大小、资源、动画帧图像以及第三方库影响APK的大小，Android Studio及Android SDK提供了一些工具用来减少资源大小及外部依赖。</p>
<p>更多关于APK的瘦身方案，可参考<a href="https://developer.android.google.cn/topic/performance/reduce-apk-size.html" target="_blank" rel="external">Reduce APK Size</a>。</p>
<h4 id="u4F7F_u7528Dagger2_u5B9E_u73B0_u4F9D_u8D56_u6CE8_u5165"><a href="#u4F7F_u7528Dagger2_u5B9E_u73B0_u4F9D_u8D56_u6CE8_u5165" class="headerlink" title="使用Dagger2实现依赖注入"></a>使用Dagger2实现依赖注入</h4><p>依赖注入框架可以简化代码并为测试及其他配置变化提供适配环境。</p>
<p>如果打算在App中使用依赖注入框架的话，建议使用<a href="http://google.github.io/dagger/" target="_blank" rel="external">Dagger2</a>。Dagger没有使用反射，它的静态、编译时实现意味着它不需要运行时成本及内存消耗。</p>
<p>其他使用反射的依赖注入框架需要扫描代码来寻找注解，这个过程可能需要更多的CPU周期和RAM，并可能导致应用程序启动的明显滞后。</p>
<h4 id="u8C28_u614E_u4F7F_u7528_u5916_u90E8Library"><a href="#u8C28_u614E_u4F7F_u7528_u5916_u90E8Library" class="headerlink" title="谨慎使用外部Library"></a>谨慎使用外部Library</h4><p>第三方的Library代码可能并非为移动环境所写，当应用到移动客户端时可能导致性能降低。当决定使用一个第三方库时，需要针对移动环境做优化，另外需要分析Library的代码大小及内存占用情况，最后再决定是否应用该Library。</p>
<p>哪怕是一些针对移动环境做过优化的Library因为不同的实现也可能导致一些问题，如一种情况使用了Nano版的protobufs，另一种情况使用了Micro版的protobufs，不同的Library实现有可能导致意想不到的问题。</p>
<p>尽管<a href="https://developer.android.google.cn/tools/help/proguard.html" target="_blank" rel="external">Proguard</a>可以移除无效的API及资源，但是它无法移除一个Library大的内部依赖。这些库中的功能可能需要较低的依赖项，例如当使用一个库提供的Activity子类时，可能会引入大量的依赖。</p>
<p>需要避免只使用一个库中的有限的功能而引入库的情况，我们不希望引入大量不需要的代码。当决定是否使用一个Library时，尽可能高度匹配我们的需求，否则，可以考虑自己实现。</p>
<p>参考文献<a href="https://developer.android.google.cn/topic/performance/memory.html" target="_blank" rel="external">Manage Your App’s Memory</a>。</p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="http://aspook.com">AN</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="http://aspook.com/2017/01/19/App内存占用优化/">http://aspook.com/2017/01/19/App内存占用优化/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/内存优化/">内存优化</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2017/01/19/面对五花八门的新技术，如何看待与学习/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">面对五花八门的新技术，如何看待与学习</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2017/01/19/Android高性能编码最佳实践/">
        <span class="next-text nav-default">Android高性能编码最佳实践</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>

      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
  </div>


        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
      
      <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2015 - 
    
    2017

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">AN</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  



    




  
    <script type="text/javascript" src="/lib/jquery/jquery-3.1.1.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>
<script type="text/javascript" src="/js/src/bootstrap.js?v=2.6.0"></script>

  </body>
</html>
