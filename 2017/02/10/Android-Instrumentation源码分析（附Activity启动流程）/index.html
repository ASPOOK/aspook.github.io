<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="请不要灰心，你也会有人妒忌"><title>Android Instrumentation源码分析（附Activity启动流程） | Aspook</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android Instrumentation源码分析（附Activity启动流程）</h1><a id="logo" href="/.">Aspook</a><p class="description">Serendipity</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android Instrumentation源码分析（附Activity启动流程）</h1><div class="post-meta">Feb 10, 2017<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/" href="/2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><h3 id="Instrumentation_u6982_u5FF5"><a href="#Instrumentation_u6982_u5FF5" class="headerlink" title="Instrumentation概念"></a>Instrumentation概念</h3><h4 id="u5B98_u65B9_u8BF4_u660E"><a href="#u5B98_u65B9_u8BF4_u660E" class="headerlink" title="官方说明"></a>官方说明</h4><p>Instrumentation类位于android.app包中，继承自java.lang.Object，一些测试用类如InstrumentationTestRunner或MultiDexTestRunner直接或间接继承自该类。官方对于该类的解释如下：</p>
<blockquote>
<p>Base class for implementing application instrumentation code. When running with instrumentation turned on, this class will be instantiated for you before any of the application code, allowing you to monitor all of the interaction the system has with the application. An Instrumentation implementation is described to the system through an AndroidManifest.xml’s instrumentation tag.</p>
</blockquote>
<p>大意是当instrumentation开启的话，它会在应用程序的任何组件创建之前初始化，可以用来监控系统与应用的所有交互。系统可以根据AndroidManifest.xml中的 instrumentation 标签来实现instrumentation。</p>
<h4 id="u5728AndroidManifest-xml_u4E2D_u7684_u58F0_u660E_u65B9_u5F0F_u53CA_u5C5E_u6027_u89E3_u91CA"><a href="#u5728AndroidManifest-xml_u4E2D_u7684_u58F0_u660E_u65B9_u5F0F_u53CA_u5C5E_u6027_u89E3_u91CA" class="headerlink" title="在AndroidManifest.xml中的声明方式及属性解释"></a>在AndroidManifest.xml中的声明方式及属性解释</h4><p>语法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="title">instrumentation</span> <span class="attribute">android:functionalTest</span>=<span class="value">["true"</span> | "<span class="attribute">false</span>"]</span><br><span class="line">                 <span class="attribute">android:handleProfiling</span>=<span class="value">["true"</span> | "<span class="attribute">false</span>"]</span><br><span class="line">                 <span class="attribute">android:icon</span>=<span class="value">"drawable resource"</span></span><br><span class="line">                 <span class="attribute">android:label</span>=<span class="value">"string resource"</span></span><br><span class="line">                 <span class="attribute">android:name</span>=<span class="value">"string"</span></span><br><span class="line">                 <span class="attribute">android:targetPackage</span>=<span class="value">"string"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<p>父元素：</p>
<p>manifest</p>
<p>描述：</p>
<p>声明一个Instrumentation类，可以用来监控应用与系统之间的交互。Instrumentation类的对象会在应用的所有组件创建之前初始化。</p>
<p>属性介绍：</p>
<p><code>android:functionalTest</code> </p>
<p>指定Instrumentation类是否作为一个功能性的测试来运行，如果为true，则是；如果为false，则不是，默认值为false。    </p>
<p><code>android:handleProfiling</code></p>
<p>指定Instrumentation对象是否开启和关闭分析功能。如果设置为true，那么由Instrumentation对象来决定何时启动、停止分析；如果设置为false，则分析功能会在Instrumentation对象整个运行期间启用。如果设置为true，可以使Instrumentation对象针对一组特定的操作来进行分析，默认值为false。</p>
<p><code>android:icon</code>        </p>
<p>Instrumentation类呈现给用户的图标，这个属性必须设置为一个Drawable资源的引用。</p>
<p><code>android:label</code>        </p>
<p>用户可读的Instrumentation类的标签，这个标签可以被设置为原生字符串或者字符串资源的引用。 </p>
<p><code>android:name</code>       </p>
<p>Instrumentation子类的名称，它应当是完整的类名（如，“com.example.project.StringInstrumentation”）。然而，还有一种简写方式，如果这个名称的第一个字符是英文句号，那么它将追加到manifest元素指定的包名的后面。</p>
<p>它没有默认值，必须要设置。    </p>
<p><code>android:targetPackage</code>        </p>
<p>Instrumentation对象将要运行的应用。这个应用由在它的manifest文件中由manifest元素指定的包名来确定。</p>
<h3 id="Instrumentation_u6E90_u7801_u5206_u6790"><a href="#Instrumentation_u6E90_u7801_u5206_u6790" class="headerlink" title="Instrumentation源码分析"></a>Instrumentation源码分析</h3><h4 id="u6784_u9020_u51FD_u6570"><a href="#u6784_u9020_u51FD_u6570" class="headerlink" title="构造函数"></a>构造函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Instrumentation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Instrumentation_u751F_u547D_u5468_u671F_u76F8_u5173_u7684_u65B9_u6CD5"><a href="#Instrumentation_u751F_u547D_u5468_u671F_u76F8_u5173_u7684_u65B9_u6CD5" class="headerlink" title="Instrumentation生命周期相关的方法"></a>Instrumentation生命周期相关的方法</h4><p>首先是onCreate方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Called when the instrumentation is starting, before any application code</span><br><span class="line"> * has been loaded.  Usually this will be implemented to simply call</span><br><span class="line"> * &#123;<span class="doctag">@link</span> #start&#125; to begin the instrumentation thread, which will then</span><br><span class="line"> * continue execution in &#123;<span class="doctag">@link</span> #onStart&#125;.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;If you do not need your own thread -- that is you are writing your</span><br><span class="line"> * instrumentation to be completely asynchronous (returning to the event</span><br><span class="line"> * loop so that the application can run), you can simply begin your</span><br><span class="line"> * instrumentation here, for example call &#123;<span class="doctag">@link</span> Context#startActivity&#125; to</span><br><span class="line"> * begin the appropriate first activity of the application. </span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@param</span> arguments Any additional arguments that were supplied when the </span><br><span class="line"> *                  instrumentation was started.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当启动一个instrumentation时会调用上述onCreate方法，它会在所有应用程序代码加载完成之前启动。在Instrumentation源码中，它是一个空方法，因此会在其实现类中重写，如在InstrumentationTestRunner中就重写了onCreate，并在最后调用了start()方法。</p>
<p>start方法会启动一个新的线程用来执行instrumentation，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create and start a new thread in which to run instrumentation.  This new</span><br><span class="line"> * thread will call to &#123;<span class="doctag">@link</span> #onStart&#125; where you can implement the</span><br><span class="line"> * instrumentation.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mRunner != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Instrumentation already started"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mRunner = <span class="keyword">new</span> InstrumentationThread(<span class="string">"Instr: "</span> + getClass().getName());</span><br><span class="line">    mRunner.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中mRunner是InstrumentationThread的一个实例，表示Instrumentation所在的线程，该线程启动后会执行onStart()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentationThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentationThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process.setThreadPriority(Process.THREAD_PRIORITY_URGENT_DISPLAY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">"Exception setting priority of instrumentation thread "</span></span><br><span class="line">                    + Process.myTid(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mAutomaticPerformanceSnapshots) &#123;</span><br><span class="line">            startPerformanceSnapshot();</span><br><span class="line">        &#125;</span><br><span class="line">        onStart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来看onStart方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Method where the instrumentation thread enters execution.  This allows</span><br><span class="line"> * you to run your instrumentation code in a separate thread than the</span><br><span class="line"> * application, so that it can perform blocking operation such as</span><br><span class="line"> * &#123;<span class="doctag">@link</span> #sendKeySync&#125; or &#123;<span class="doctag">@link</span> #startActivitySync&#125;.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;You will typically want to call finish() when this function is done,</span><br><span class="line"> * to end your instrumentation.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在onStart()里面可以具体实现instrumentation的逻辑，但在Instrumentation中它也是个空方法，需要重写该方法，从而可以测试一些阻塞性的操作，当功能完成时可以调用finish()方法来结束instrumentation，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Terminate instrumentation of the application.  This will cause the</span><br><span class="line"> * application process to exit, removing this instrumentation from the next</span><br><span class="line"> * time the application is started. </span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@param</span> resultCode Overall success/failure of instrumentation. </span><br><span class="line"> * <span class="doctag">@param</span> results Any results to send back to the code that started the </span><br><span class="line"> *                instrumentation.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finish</span><span class="params">(<span class="keyword">int</span> resultCode, Bundle results)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mAutomaticPerformanceSnapshots) &#123;</span><br><span class="line">        endPerformanceSnapshot();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mPerfMetrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (results == <span class="keyword">null</span>) &#123;</span><br><span class="line">            results = <span class="keyword">new</span> Bundle();</span><br><span class="line">        &#125;</span><br><span class="line">        results.putAll(mPerfMetrics);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((mUiAutomation != <span class="keyword">null</span>) &amp;&amp; !mUiAutomation.isDestroyed()) &#123;</span><br><span class="line">        mUiAutomation.disconnect();</span><br><span class="line">        mUiAutomation = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mThread.finishInstrumentation(resultCode, results);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>finish方法会终止应用程序的instrumentation，同时应用进程退出，下次该应用再次启动时会移除该instrumentation。</p>
<p>最后是onDestroy方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Called when the instrumented application is stopping, after all of the</span><br><span class="line"> * normal application cleanup has occurred.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此方法当应用程序停止检测，且所有应用被清理之后才会执行。</p>
<h4 id="u83B7_u53D6Context_u7684_u4E24_u4E2A_u65B9_u6CD5"><a href="#u83B7_u53D6Context_u7684_u4E24_u4E2A_u65B9_u6CD5" class="headerlink" title="获取Context的两个方法"></a>获取Context的两个方法</h4><p>第一个是获取instrumentation所在包的上下文对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Return the Context of this instrumentation's package.  Note that this is</span><br><span class="line"> * often different than the Context of the application being</span><br><span class="line"> * instrumentated, since the instrumentation code often lives is a</span><br><span class="line"> * different package than that of the application it is running against.</span><br><span class="line"> * See &#123;<span class="doctag">@link</span> #getTargetContext&#125; to retrieve a Context for the target</span><br><span class="line"> * application.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> The instrumentation's package context.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@see</span> #getTargetContext</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mInstrContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个是获取被检测的应用的上下文对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Return a Context for the target application being instrumented.  Note</span><br><span class="line"> * that this is often different than the Context of the instrumentation</span><br><span class="line"> * code, since the instrumentation code often lives is a different package</span><br><span class="line"> * than that of the application it is running against. See</span><br><span class="line"> * &#123;<span class="doctag">@link</span> #getContext&#125; to retrieve a Context for the instrumentation code.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> A Context in the target application.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@see</span> #getContext</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getTargetContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mAppContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么会有上面两个不同的Context呢？是因为instrumentation的代码经常运行在另一个包（或者叫进程）中，而被检测的应用是另一个进程。</p>
<h4 id="u63A7_u5236_u6027_u80FD_u5206_u6790_u7684_u51E0_u4E2A_u65B9_u6CD5"><a href="#u63A7_u5236_u6027_u80FD_u5206_u6790_u7684_u51E0_u4E2A_u65B9_u6CD5" class="headerlink" title="控制性能分析的几个方法"></a>控制性能分析的几个方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Check whether this instrumentation was started with profiling enabled.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> Returns true if profiling was enabled when starting, else false.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isProfiling</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mThread.isProfiling();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * This method will start profiling if isProfiling() returns true. You should</span><br><span class="line"> * only call this method if you set the handleProfiling attribute in the </span><br><span class="line"> * manifest file for this Instrumentation to true.  </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startProfiling</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThread.isProfiling()) &#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(mThread.getProfileFilePath());</span><br><span class="line">        file.getParentFile().mkdirs();</span><br><span class="line">        Debug.startMethodTracing(file.toString(), <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line"> * Stops profiling if isProfiling() returns true.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopProfiling</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mThread.isProfiling()) &#123;</span><br><span class="line">        Debug.stopMethodTracing();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutomaticPerformanceSnapshots</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mAutomaticPerformanceSnapshots = <span class="keyword">true</span>;</span><br><span class="line">    mPerformanceCollector = <span class="keyword">new</span> PerformanceCollector();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startPerformanceSnapshot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isProfiling()) &#123;</span><br><span class="line">        mPerformanceCollector.beginSnapshot(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endPerformanceSnapshot</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isProfiling()) &#123;</span><br><span class="line">        mPerfMetrics = mPerformanceCollector.endSnapshot();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面几个方法比较简单，通过注释即可理解其用途。</p>
<h4 id="u4E24_u4E2A_u6BD4_u8F83_u91CD_u8981_u7684_u5185_u90E8_u7C7B"><a href="#u4E24_u4E2A_u6BD4_u8F83_u91CD_u8981_u7684_u5185_u90E8_u7C7B" class="headerlink" title="两个比较重要的内部类"></a>两个比较重要的内部类</h4><h5 id="Instrumentation-ActivityResult"><a href="#Instrumentation-ActivityResult" class="headerlink" title="Instrumentation.ActivityResult"></a>Instrumentation.ActivityResult</h5><p>该类大家应该很熟悉，我们经常使用startActivityForResult，这个类就是用来封装从第二个Activity返回的结果的，其源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Description of a Activity execution result to return to the original</span><br><span class="line"> * activity.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityResult</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Create a new activity result.  See &#123;<span class="doctag">@link</span> Activity#setResult&#125; for </span><br><span class="line">     * more information. </span><br><span class="line">     *  </span><br><span class="line">     * <span class="doctag">@param</span> resultCode The result code to propagate back to the</span><br><span class="line">     * originating activity, often RESULT_CANCELED or RESULT_OK</span><br><span class="line">     * <span class="doctag">@param</span> resultData The data to propagate back to the originating</span><br><span class="line">     * activity.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ActivityResult</span><span class="params">(<span class="keyword">int</span> resultCode, Intent resultData)</span> </span>&#123;</span><br><span class="line">        mResultCode = resultCode;</span><br><span class="line">        mResultData = resultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Retrieve the result code contained in this result.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getResultCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mResultCode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Retrieve the data contained in this result.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Intent <span class="title">getResultData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mResultData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mResultCode;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Intent mResultData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该类非常简单，维护了一个整型的resultCode以及一个Intent类型的resultData，可以结合常用的onActivityResult回调来印证一下。</p>
<h5 id="Instrumentation-ActivityMonitor"><a href="#Instrumentation-ActivityMonitor" class="headerlink" title="Instrumentation.ActivityMonitor"></a>Instrumentation.ActivityMonitor</h5><p>该类官方注释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Information about a particular kind of Intent that is being monitored.</span><br><span class="line"> * An instance of this class is added to the </span><br><span class="line"> * current instrumentation through &#123;<span class="doctag">@link</span> #addMonitor&#125;; after being added, </span><br><span class="line"> * when a new activity is being started the monitor will be checked and, if </span><br><span class="line"> * matching, its hit count updated and (optionally) the call stopped and a </span><br><span class="line"> * canned result returned.</span><br><span class="line"> * </span><br><span class="line"> * &lt;p&gt;An ActivityMonitor can also be used to look for the creation of an</span><br><span class="line"> * activity, through the &#123;<span class="doctag">@link</span> #waitForActivity&#125; method.  This will return</span><br><span class="line"> * after a matching activity has been created with that activity object.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityMonitor</span> </span>&#123;</span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从注释可知ActivityMonitor可以用来监控某个特定Intent的信息，可以通过Instrumentation.addMonitor方法来添加ActivityMonitor的实例。当一个新的Activity被启动时，会匹配Instrumentation中的ActivityMonitory实例列表，如果匹配，就会累加命中计数器。ActivityMonitor也可以被用于获取新创建的Activity，通过waitForActivity方法，可以返回一个匹配IntentFilter的Activity对象。</p>
<h6 id="u6210_u5458_u53D8_u91CF"><a href="#u6210_u5458_u53D8_u91CF" class="headerlink" title="成员变量"></a>成员变量</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IntentFilter mWhich;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String mClass;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ActivityResult mResult;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> mBlock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This is protected by 'Instrumentation.this.mSync'.</span></span><br><span class="line"><span class="comment">/*package*/</span> <span class="keyword">int</span> mHits = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This is protected by 'this'.</span></span><br><span class="line"><span class="comment">/*package*/</span> Activity mLastActivity = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>
<h6 id="u6784_u9020_u51FD_u6570-1"><a href="#u6784_u9020_u51FD_u6570-1" class="headerlink" title="构造函数"></a>构造函数</h6><p>ActivityMonitor有两种构造方法，其一：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a new ActivityMonitor that looks for a particular kind of </span><br><span class="line"> * intent to be started.</span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@param</span> which The set of intents this monitor is responsible for.</span><br><span class="line"> * <span class="doctag">@param</span> result A canned result to return if the monitor is hit; can </span><br><span class="line"> *               be null.</span><br><span class="line"> * <span class="doctag">@param</span> block Controls whether the monitor should block the activity </span><br><span class="line"> *              start (returning its canned result) or let the call</span><br><span class="line"> *              proceed.</span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@see</span> Instrumentation#addMonitor </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityMonitor</span><span class="params">(</span><br><span class="line">    IntentFilter which, ActivityResult result, <span class="keyword">boolean</span> block)</span> </span>&#123;</span><br><span class="line">    mWhich = which;</span><br><span class="line">    mClass = <span class="keyword">null</span>;</span><br><span class="line">    mResult = result;</span><br><span class="line">    mBlock = block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其二：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Create a new ActivityMonitor that looks for a specific activity </span><br><span class="line"> * class to be started. </span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@param</span> cls The activity class this monitor is responsible for.</span><br><span class="line"> * <span class="doctag">@param</span> result A canned result to return if the monitor is hit; can </span><br><span class="line"> *               be null.</span><br><span class="line"> * <span class="doctag">@param</span> block Controls whether the monitor should block the activity </span><br><span class="line"> *              start (returning its canned result) or let the call</span><br><span class="line"> *              proceed.</span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@see</span> Instrumentation#addMonitor </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityMonitor</span><span class="params">(</span><br><span class="line">    String cls, ActivityResult result, <span class="keyword">boolean</span> block)</span> </span>&#123;</span><br><span class="line">    mWhich = <span class="keyword">null</span>;</span><br><span class="line">    mClass = cls;</span><br><span class="line">    mResult = result;</span><br><span class="line">    mBlock = block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比较上面两个构造方法可知，只有一个参数不同：一个需要IntentFilter，而另一个需要Activity的类名。</p>
<h6 id="waitForActivity_u65B9_u6CD5"><a href="#waitForActivity_u65B9_u6CD5" class="headerlink" title="waitForActivity方法"></a>waitForActivity方法</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Block until an Activity is created that matches this monitor, </span><br><span class="line"> * returning the resulting activity. </span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> Activity</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Activity <span class="title">waitForActivity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">while</span> (mLastActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Activity res = mLastActivity;</span><br><span class="line">        mLastActivity = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从注释可知，该方法会阻塞直到有匹配该ActivityMonitor的Activity创建完成，最后将该Activity返回。</p>
<h6 id="waitForActivityWithTimeout_u65B9_u6CD5"><a href="#waitForActivityWithTimeout_u65B9_u6CD5" class="headerlink" title="waitForActivityWithTimeout方法"></a>waitForActivityWithTimeout方法</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Block until an Activity is created that matches this monitor, </span><br><span class="line"> * returning the resulting activity or till the timeOut period expires.</span><br><span class="line"> * If the timeOut expires before the activity is started, return null. </span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@param</span> timeOut Time to wait in milliseconds before the activity is created.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> Activity</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Activity <span class="title">waitForActivityWithTimeout</span><span class="params">(<span class="keyword">long</span> timeOut)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLastActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                wait(timeOut);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mLastActivity == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Activity res = mLastActivity;</span><br><span class="line">            mLastActivity = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述方法则会有超时限制，超市之后将返回null。</p>
<h6 id="match_u65B9_u6CD5"><a href="#match_u65B9_u6CD5" class="headerlink" title="match方法"></a>match方法</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Context who,</span><br><span class="line">                    Activity activity,</span><br><span class="line">                    Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mWhich != <span class="keyword">null</span></span><br><span class="line">            &amp;&amp; mWhich.match(who.getContentResolver(), intent,</span><br><span class="line">                            <span class="keyword">true</span>, <span class="string">"Instrumentation"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String cls = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cls = activity.getClass().getName();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (intent.getComponent() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                cls = intent.getComponent().getClassName();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cls == <span class="keyword">null</span> || !mClass.equals(cls)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mLastActivity = activity;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述方法顾名思义，它会在启动Activity时调用。从代码中可知，它先回根据IntentFilter判断是否匹配，然后再根据Activity的类名进行判断。</p>
<h4 id="u4E00_u7CFB_u5217_u64CD_u4F5C_u4E8B_u4EF6_u65B9_u6CD5"><a href="#u4E00_u7CFB_u5217_u64CD_u4F5C_u4E8B_u4EF6_u65B9_u6CD5" class="headerlink" title="一系列操作事件方法"></a>一系列操作事件方法</h4><ul>
<li><code>public boolean invokeMenuActionSync(Activity targetActivity, int id, int flag)</code></li>
<li><code>public boolean invokeContextMenuAction(Activity targetActivity, int id, int flag)</code></li>
<li><code>public void sendStringSync(String text)</code></li>
<li><code>public void sendKeySync(KeyEvent event)</code></li>
<li><code>public void sendKeyDownUpSync(int key)</code></li>
<li><code>public void sendCharacterSync(int keyCode)</code></li>
<li><code>public void sendPointerSync(MotionEvent event)</code></li>
<li><code>public void sendTrackballEventSync(MotionEvent event)</code></li>
</ul>
<p>上述方法主要用于辅助测试，根据方法名及注释即可理解，不做赘述。</p>
<h4 id="ActivityMonitor_u76F8_u5173_u7684_u65B9_u6CD5"><a href="#ActivityMonitor_u76F8_u5173_u7684_u65B9_u6CD5" class="headerlink" title="ActivityMonitor相关的方法"></a>ActivityMonitor相关的方法</h4><p>以下3个方法时用来将ActivityMonitor对象添加到一个ActivityMonitor列表中，具体实现为ArrayList。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMonitor</span><span class="params">(ActivityMonitor monitor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mActivityMonitors == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mActivityMonitors = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        &#125;</span><br><span class="line">        mActivityMonitors.add(monitor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityMonitor <span class="title">addMonitor</span><span class="params">(</span><br><span class="line">    IntentFilter filter, ActivityResult result, <span class="keyword">boolean</span> block)</span> </span>&#123;</span><br><span class="line">    ActivityMonitor am = <span class="keyword">new</span> ActivityMonitor(filter, result, block);</span><br><span class="line">    addMonitor(am);</span><br><span class="line">    <span class="keyword">return</span> am;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityMonitor <span class="title">addMonitor</span><span class="params">(</span><br><span class="line">    String cls, ActivityResult result, <span class="keyword">boolean</span> block)</span> </span>&#123;</span><br><span class="line">    ActivityMonitor am = <span class="keyword">new</span> ActivityMonitor(cls, result, block);</span><br><span class="line">    addMonitor(am);</span><br><span class="line">    <span class="keyword">return</span> am;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面方法用来检查ActivityMonitor是否匹配：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkMonitorHit</span><span class="params">(ActivityMonitor monitor, <span class="keyword">int</span> minHits)</span> </span>&#123;</span><br><span class="line">    waitForIdleSync();</span><br><span class="line">    <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">        <span class="keyword">if</span> (monitor.getHits() &lt; minHits) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mActivityMonitors.remove(monitor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面来个方法用来返回匹配的Activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">waitForMonitor</span><span class="params">(ActivityMonitor monitor)</span> </span>&#123;</span><br><span class="line">    Activity activity = monitor.waitForActivity();</span><br><span class="line">    <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">        mActivityMonitors.remove(monitor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">waitForMonitorWithTimeout</span><span class="params">(ActivityMonitor monitor, <span class="keyword">long</span> timeOut)</span> </span>&#123;</span><br><span class="line">    Activity activity = monitor.waitForActivityWithTimeout(timeOut);</span><br><span class="line">    <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">        mActivityMonitors.remove(monitor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是删除ActivityMonitor的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Remove an &#123;<span class="doctag">@link</span> ActivityMonitor&#125; that was previously added with </span><br><span class="line"> * &#123;<span class="doctag">@link</span> #addMonitor&#125;.</span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@param</span> monitor The monitor to remove.</span><br><span class="line"> *  </span><br><span class="line"> * <span class="doctag">@see</span> #addMonitor </span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeMonitor</span><span class="params">(ActivityMonitor monitor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">        mActivityMonitors.remove(monitor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Activity_u542F_u52A8_u6D41_u7A0B_uFF08Application_u7684_u521B_u5EFA_uFF09"><a href="#Activity_u542F_u52A8_u6D41_u7A0B_uFF08Application_u7684_u521B_u5EFA_uFF09" class="headerlink" title="Activity启动流程（Application的创建）"></a>Activity启动流程（Application的创建）</h4><p>如果你在阅读Instrumentation的源码时发现了关于创建Application和Activity的方法，请不要惊讶，是否瞬间感觉这个类相当重要。我们都知道，每个App都只有一个Application实例，如果在源码中跟踪过Activity的启动过程，也许还记得Application的最终创建就是位于Instrumentation中的。</p>
<p>我们大概浏览一下源码中启动一个Activity的流程，以Activity A启动Activity B为例：</p>
<p>1.startActivity方法有多种重载形式，但最终都会走到startActivityForResult，源码位于Activity.java中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span><br><span class="line">        @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                intent, requestCode, options);</span><br><span class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mMainThread.sendActivityResult(</span><br><span class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                ar.getResultData());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// If this start is requesting a result, we can avoid making</span></span><br><span class="line">            <span class="comment">// the activity visible until the result is received.  Setting</span></span><br><span class="line">            <span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></span><br><span class="line">            <span class="comment">// activity hidden during this time, to avoid flickering.</span></span><br><span class="line">            <span class="comment">// This can only be done when a result is requested because</span></span><br><span class="line">            <span class="comment">// that guarantees we will get information back when the</span></span><br><span class="line">            <span class="comment">// activity is finished, no matter what happens to it.</span></span><br><span class="line">            mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        cancelInputsAndStartExitTransition(options);</span><br><span class="line">        <span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line">            <span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">            mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到此段代码中已经有了Instrumentation，对应代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Instrumentation.ActivityResult ar =</span><br><span class="line">    mInstrumentation.execStartActivity(</span><br><span class="line">        <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">        intent, requestCode, options);</span><br></pre></td></tr></table></figure>
<p>我们先来看Activity.java中的mInstrumentation是何时初始化的，然后再看上述方法的具体实现。</p>
<p>经搜索发现mInstrumentation是在Activity的attach方法中赋值的，具体代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation = instr;</span><br></pre></td></tr></table></figure>
<p>那么Activity的attach方法时何时调用的呢？这里先放一放，稍后会提到。</p>
<p>2.接着来看<code>mInstrumentation.execStartActivity(    this, mMainThread.getApplicationThread(), mToken, this,    intent, requestCode, options);</code>的具体实现，代码位于Instrumentation.java中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span><br><span class="line">        Context who, IBinder contextThread, IBinder token, Activity target,</span><br><span class="line">        Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</span><br><span class="line">                    am.mHits++;</span><br><span class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上述代码不难看出Activity的真正启动逻辑是由下面几句完成的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">    .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">            intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">            token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">            requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">checkStartActivityResult(result, intent);</span><br></pre></td></tr></table></figure>
<p>其中最后一句<code>checkStartActivityResult(result, intent);</code>是用来检查Activity的启动情况，我们经常忘记在AndroidManifest.xml注册Activity，从而会报异常：</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; have you declared <span class="keyword">this</span> activity in your AndroidManifest.xml?</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>这句异常就是在<code>checkStartActivityResult(result, intent);</code>中实现的。</p>
<p>言归正传，上述代码中是由<code>ActivityManagerNative.getDefault()</code>来启动Activity的，<code>ActivityManagerNative.getDefault()</code>返回一个IActivityManager对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Retrieve the system's default/global activity manager.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gDefault.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们知道ActivityManagerNative继承自Binder并实现了IActivityManager接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>在IActivityManager接口中定义了上述启动Activity的方法，但没有实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivities</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">        Intent[] intents, String[] resolvedTypes, IBinder resultTo,</span><br><span class="line">        Bundle options, <span class="keyword">int</span> userId)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br></pre></td></tr></table></figure>
<p>其具体实现是在ActivityManagerService中，ActivityManagerService源码路径为：</p>
<blockquote>
<p>/frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
</blockquote>
<p>可以看到ActivityManagerService继承自ActivityManagerNative：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerService</span> <span class="keyword">extends</span> <span class="title">ActivityManagerNative</span> <span class="keyword">implements</span> <span class="title">Watchdog</span>.<span class="title">Monitor</span>, <span class="title">BatteryStatsImpl</span>.<span class="title">BatteryCallback</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>3.现在逻辑已经到了ActivityManagerService中，找到对应的启动Activity的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivities</span><span class="params">(IApplicationThread caller, String callingPackage,</span><br><span class="line">                                 Intent[] intents, String[] resolvedTypes, IBinder resultTo, Bundle options,</span><br><span class="line">                                 <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivities"</span>);</span><br><span class="line">    userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</span><br><span class="line">            <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">int</span> ret = mStackSupervisor.startActivities(caller, -<span class="number">1</span>, callingPackage, intents,</span><br><span class="line">            resolvedTypes, resultTo, options, userId);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析上述代码发现启动逻辑又转移到了ActivityStackSupervisor中。ActivityStackSupervisor源码路径为：</p>
<blockquote>
<p>/frameworks/base/services/core/java/com/android/server/am/ActivityStackSupervisor.java</p>
</blockquote>
<p>由于代码片段比较长，下面仅罗列主要流程：</p>
<p>ActivityStackSupervisor—&gt;startActivities()</p>
<p>ActivityStackSupervisor—&gt;startActivityLocked()</p>
<p>ActivityStackSupervisor—&gt;startActivityUncheckedLocked()</p>
<p>ActivityStack—&gt;startActivityLocked()</p>
<p>ActivityStackSupervisor—&gt;resumeTopActivitiesLocked()</p>
<p>ActivityStack—&gt;resumeTopActivityLocked()</p>
<p>ActivityStack—&gt;resumeTopActivityInnerLocked()</p>
<p>ActivityStackSupervisor—&gt;startSpecificActivityLocked()</p>
<p>ActivityStackSupervisor—&gt;realStartActivityLocked()</p>
<p>其中ActivityStack源码路径为：</p>
<blockquote>
<p>/frameworks/base/services/core/java/com/android/server/am/ActivityStack.java</p>
</blockquote>
<p>4.在ActivityStackSupervisor的realStartActivityLocked()方法中，有这样一段关键代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken, System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration), r.compat, r.launchedFromPackage, r.task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure>
<p>其中app.thread类型为IApplicationThread，IApplicationThread的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * System private API for communicating with the application.  This is given to</span><br><span class="line"> * the activity manager by an application  when it starts up, for the activity</span><br><span class="line"> * manager to tell the application about things it needs to do.</span><br><span class="line"> *</span><br><span class="line"> * &#123;<span class="doctag">@hide</span>&#125;</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IApplicationThread</span> <span class="keyword">extends</span> <span class="title">IInterface</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>IApplicationThread接口定义了上述启动Activity的方法，但接口中没有实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span><br><span class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span><br><span class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span><br><span class="line">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br></pre></td></tr></table></figure>
<p>接下来需要找到IApplicationThread接口的实现者，我们想到ActivityThread中有一个叫做ApplicationThread的内部类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationThread</span> <span class="keyword">extends</span> <span class="title">ApplicationThreadNative</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>ApplicationThread继承自ApplicationThreadNative，而ApplicationThreadNative继承自Binder并实现了IApplicationThread接口，所以ApplicationThread就是IApplicationThread的具体实现者。</p>
<p>5.于是Activity的启动流程又变为：</p>
<p>ActivityThread.ApplicationThread—&gt;scheduleLaunchActivity()，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span><br><span class="line">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span><br><span class="line">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="line">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span><br><span class="line">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span><br><span class="line">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">    r.token = token;</span><br><span class="line">    r.ident = ident;</span><br><span class="line">    r.intent = intent;</span><br><span class="line">    r.referrer = referrer;</span><br><span class="line">    r.voiceInteractor = voiceInteractor;</span><br><span class="line">    r.activityInfo = info;</span><br><span class="line">    r.compatInfo = compatInfo;</span><br><span class="line">    r.state = state;</span><br><span class="line">    r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">    r.pendingResults = pendingResults;</span><br><span class="line">    r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">    r.startsNotResumed = notResumed;</span><br><span class="line">    r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">    r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">    r.overrideConfig = overrideConfig;</span><br><span class="line">    updatePendingConfiguration(curConfig);</span><br><span class="line"></span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>源码很简单，就是发送了一个LAUNCH_ACTIVITY的消息给名为H的handler处理，接下来看消息处理逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">    <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">    r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">            r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">    handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>6.启动逻辑变为</p>
<p>ActivityThread—&gt;handleLaunchActivity()</p>
<p>接着看handleLaunchActivity(r, null, “LAUNCH_ACTIVITY”)的具体实现:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// If we are getting ready to gc after going to the background, well</span></span><br><span class="line">    <span class="comment">// we are back active so skip it.</span></span><br><span class="line">    unscheduleGcIdler();</span><br><span class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.profilerInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.setProfiler(r.profilerInfo);</span><br><span class="line">        mProfiler.startProfiling();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure we are running with the most recent config.</span></span><br><span class="line">    handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">        TAG, <span class="string">"Handling launch of "</span> + r);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialize before creating the activity</span></span><br><span class="line">    WindowManagerGlobal.initialize();</span><br><span class="line"></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</span><br><span class="line">        reportSizeConfigurations(r);</span><br><span class="line">        Bundle oldState = r.state;</span><br><span class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</span><br><span class="line">            <span class="comment">// The activity manager actually wants this one to start out paused, because it</span></span><br><span class="line">            <span class="comment">// needs to be visible but isn't in the foreground. We accomplish this by going</span></span><br><span class="line">            <span class="comment">// through the normal startup (because activities expect to go through onResume()</span></span><br><span class="line">            <span class="comment">// the first time they run, before their window is displayed), and then pausing it.</span></span><br><span class="line">            <span class="comment">// However, in this case we do -not- need to do the full pause cycle (of freezing</span></span><br><span class="line">            <span class="comment">// and such) because the activity manager assumes it can just retain the current</span></span><br><span class="line">            <span class="comment">// state it has.</span></span><br><span class="line">            performPauseActivityIfNeeded(r, reason);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// We need to keep around the original state, in case we need to be created again.</span></span><br><span class="line">            <span class="comment">// But we only do this for pre-Honeycomb apps, which always save their state when</span></span><br><span class="line">            <span class="comment">// pausing, so we can not have them save their state when restarting from a paused</span></span><br><span class="line">            <span class="comment">// state. For HC and later, we want to (and can) let the state be saved as the</span></span><br><span class="line">            <span class="comment">// normal part of stopping the activity.</span></span><br><span class="line">            <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">                r.state = oldState;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If there was an error, for any reason, tell the activity manager to stop us.</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ActivityManagerNative.getDefault()</span><br><span class="line">                .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</span><br><span class="line">                        Activity.DONT_FINISH_TASK_WITH_ACTIVITY);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中一行关键代码是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Activity a = performLaunchActivity(r, customIntent);</span><br></pre></td></tr></table></figure>
<p>接着看ActivityThread—&gt;performLaunchActivity()的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 从ActivityClientRecord中得到待启动的Activity组件的信息</span></span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = r.intent.resolveActivity(</span><br><span class="line">            mInitialApplication.getPackageManager());</span><br><span class="line">        r.intent.setComponent(component);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</span><br><span class="line">                r.activityInfo.targetActivity);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 通过Instrumentation的newActivity方法来创建Activity对象</span></span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 创建Application</span></span><br><span class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Performing launch of "</span> + r);</span><br><span class="line">        <span class="keyword">if</span> (localLOGV) Slog.v(</span><br><span class="line">                TAG, r + <span class="string">": app="</span> + app</span><br><span class="line">                + <span class="string">", appName="</span> + app.getPackageName()</span><br><span class="line">                + <span class="string">", pkg="</span> + r.packageInfo.getPackageName()</span><br><span class="line">                + <span class="string">", comp="</span> + r.intent.getComponent().toShortString()</span><br><span class="line">                + <span class="string">", dir="</span> + r.packageInfo.getAppDir());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Context appContext = createBaseContextForActivity(r, activity);</span><br><span class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</span><br><span class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</span><br><span class="line">            <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">                config.updateFrom(r.overrideConfig);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Launching activity "</span></span><br><span class="line">                    + r.activityInfo.name + <span class="string">" with config "</span> + config);</span><br><span class="line">            Window window = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">                window = r.mPendingRemoveWindow;</span><br><span class="line">                r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">                r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          <span class="comment">// 调用Activity的attach方法</span></span><br><span class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                    r.referrer, r.voiceInteractor, window);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                activity.mIntent = customIntent;</span><br><span class="line">            &#125;</span><br><span class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</span><br><span class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">                activity.setTheme(theme);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                    <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                    <span class="string">" did not call through to super.onCreate()"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            r.activity = activity;</span><br><span class="line">            r.stopped = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.performStart();</span><br><span class="line">                r.stopped = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</span><br><span class="line">                                r.persistentState);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">                activity.mCalled = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</span><br><span class="line">                            r.persistentState);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!activity.mCalled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> SuperNotCalledException(</span><br><span class="line">                        <span class="string">"Activity "</span> + r.intent.getComponent().toShortString() +</span><br><span class="line">                        <span class="string">" did not call through to super.onPostCreate()"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        r.paused = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">        mActivities.put(r.token, r);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (SuperNotCalledException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to start activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码主要做了4件事情：</p>
<ol>
<li>从ActivityClientRecord中得到待启动的Activity组件的信息</li>
<li>通过Instrumentation的newActivity方法来创建Activity对象</li>
<li>创建Application对象</li>
<li>调用新启动Activity的attach方法</li>
</ol>
<p>上述四个逻辑对应的源码详见中文注释。</p>
<p>对于上述4件事情，我们主要关注以下几点：</p>
<p>1.Instrumentation的newActivity的实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Perform instantiation of the process's &#123;<span class="doctag">@link</span> Activity&#125; object.  The</span><br><span class="line"> * default implementation provides the normal system behavior.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@param</span> cl The ClassLoader with which to instantiate the object.</span><br><span class="line"> * <span class="doctag">@param</span> className The name of the class implementing the Activity</span><br><span class="line"> *                  object.</span><br><span class="line"> * <span class="doctag">@param</span> intent The Intent object that specified the activity class being</span><br><span class="line"> *               instantiated.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> The newly instantiated Activity object.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Activity <span class="title">newActivity</span><span class="params">(ClassLoader cl, String className,</span><br><span class="line">        Intent intent)</span></span><br><span class="line">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException,</span><br><span class="line">        ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Activity)cl.loadClass(className).newInstance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很简单，使用类加载器初始化一个Activity对象。</p>
<p>2.再来看下Application对象是如何创建出来的，以下为对应代码：</p>
<p><code>Application app = r.packageInfo.makeApplication(false, mInstrumentation);</code></p>
<p>其中r.packageInfo为LoadedApk对象，在LoadedApk类中的具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">makeApplication</span><span class="params">(<span class="keyword">boolean</span> forceDefaultAppClass,</span><br><span class="line">        Instrumentation instrumentation)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"makeApplication"</span>);</span><br><span class="line"></span><br><span class="line">    Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    String appClass = mApplicationInfo.className;</span><br><span class="line">    <span class="keyword">if</span> (forceDefaultAppClass || (appClass == <span class="keyword">null</span>)) &#123;</span><br><span class="line">        appClass = <span class="string">"android.app.Application"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = getClassLoader();</span><br><span class="line">        <span class="keyword">if</span> (!mPackageName.equals(<span class="string">"android"</span>)) &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,</span><br><span class="line">                    <span class="string">"initializeJavaContextClassLoader"</span>);</span><br><span class="line">            initializeJavaContextClassLoader();</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">        &#125;</span><br><span class="line">        ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="keyword">this</span>);</span><br><span class="line">        app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">                cl, appClass, appContext);</span><br><span class="line">        appContext.setOuterContext(app);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate application "</span> + appClass</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mActivityThread.mAllApplications.add(app);</span><br><span class="line">    mApplication = app;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (instrumentation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            instrumentation.callApplicationOnCreate(app);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!instrumentation.onException(app, e)) &#123;</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                    <span class="string">"Unable to create application "</span> + app.getClass().getName()</span><br><span class="line">                    + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Rewrite the R 'constants' for all library apks.</span></span><br><span class="line">    SparseArray&lt;String&gt; packageIdentifiers = getAssets(mActivityThread)</span><br><span class="line">            .getAssignedPackageIdentifiers();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> N = packageIdentifiers.size();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> id = packageIdentifiers.keyAt(i);</span><br><span class="line">        <span class="keyword">if</span> (id == <span class="number">0x01</span> || id == <span class="number">0x7f</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到源码中有如下判断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mApplication != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正是因为每个App中只有一个Application的实例。接下来可以看到创建Application的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app = mActivityThread.mInstrumentation.newApplication(</span><br><span class="line">        cl, appClass, appContext);</span><br></pre></td></tr></table></figure>
<p>最终仍然是进入到Instrumentation中，继续跟踪：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Perform instantiation of the process's &#123;<span class="doctag">@link</span> Application&#125; object.  The</span><br><span class="line"> * default implementation provides the normal system behavior.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@param</span> cl The ClassLoader with which to instantiate the object.</span><br><span class="line"> * <span class="doctag">@param</span> className The name of the class implementing the Application</span><br><span class="line"> *                  object.</span><br><span class="line"> * <span class="doctag">@param</span> context The context to initialize the application with</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> The newly instantiated Application object.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(ClassLoader cl, String className, Context context)</span></span><br><span class="line">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span><br><span class="line">        ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> newApplication(cl.loadClass(className), context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续调用如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Perform instantiation of the process's &#123;<span class="doctag">@link</span> Application&#125; object.  The</span><br><span class="line"> * default implementation provides the normal system behavior.</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@param</span> clazz The class used to create an Application object from.</span><br><span class="line"> * <span class="doctag">@param</span> context The context to initialize the application with</span><br><span class="line"> * </span><br><span class="line"> * <span class="doctag">@return</span> The newly instantiated Application object.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> Application <span class="title">newApplication</span><span class="params">(Class&lt;?&gt; clazz, Context context)</span></span><br><span class="line">        <span class="keyword">throws</span> InstantiationException, IllegalAccessException, </span><br><span class="line">        ClassNotFoundException </span>&#123;</span><br><span class="line">    Application app = (Application)clazz.newInstance();</span><br><span class="line">    app.attach(context);</span><br><span class="line">    <span class="keyword">return</span> app;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样，Application也是通过类加载器来创建是个实例对象。</p>
<p>当Application创建完成之后，会调用如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">instrumentation.callApplicationOnCreate(app);</span><br></pre></td></tr></table></figure>
<p>查看位于Instrumentation的具体实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Perform calling of the application's &#123;<span class="doctag">@link</span> Application#onCreate&#125;</span><br><span class="line"> * method.  The default implementation simply calls through to that method.</span><br><span class="line"> *</span><br><span class="line"> * &lt;p&gt;Note: This method will be called immediately after &#123;<span class="doctag">@link</span> #onCreate(Bundle)&#125;.</span><br><span class="line"> * Often instrumentation tests start their test thread in onCreate(); you</span><br><span class="line"> * need to be careful of races between these.  (Well between it and</span><br><span class="line"> * everything else, but let's start here.)</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> app The application being created.</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callApplicationOnCreate</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">    app.onCreate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终调用<code>app.onCreate()</code>从而触发Application的onCreate生命周期回调，到这里我们就非常熟悉了。</p>
<p>3.当Activity创建完成后，还需要为其创建相关的上下文对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Context appContext = createBaseContextForActivity(r, activity);</span><br></pre></td></tr></table></figure>
<p>然后为其创建window对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Window window = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (r.mPendingRemoveWindow != <span class="keyword">null</span> &amp;&amp; r.mPreserveWindow) &#123;</span><br><span class="line">    window = r.mPendingRemoveWindow;</span><br><span class="line">    r.mPendingRemoveWindow = <span class="keyword">null</span>;</span><br><span class="line">    r.mPendingRemoveWindowManager = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后调用Activity的attach方法，将上下文对象、window等附加到Activity上。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">        r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">        r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">        r.referrer, r.voiceInteractor, window);</span><br></pre></td></tr></table></figure>
<p>注意上述方法的第三个参数，getInstrumentation()返回的是ActivityThread的mInstrumentation实例。还记得之前遗留的问题：Activity的attach是何时调用的吗？到现在答案已经知道了。</p>
<p>Activity A启动Activity B，使用的是A的mInstrumentation，B创建完成，调用attach之后，B也就有了mInstrumentation，mInstrumentation变量在Activity中的声明为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set by the thread after the constructor and before onCreate(Bundle savedInstanceState) is called.</span></span><br><span class="line"><span class="keyword">private</span> Instrumentation mInstrumentation;</span><br></pre></td></tr></table></figure>
<p>根据注释可知，它是在构造函数之后、onCreate之前赋值的，就是上述attach方法。</p>
<p>attach之后，还可能为Activity设置主题：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</span><br><span class="line"><span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</span><br><span class="line">    activity.setTheme(theme);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来就会调用<code>mInstrumentation.callActivityOnCreate</code>，在Instrumentation的一种重载方法为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Perform calling of an activity's &#123;<span class="doctag">@link</span> Activity#onCreate&#125;</span><br><span class="line"> * method.  The default implementation simply calls through to that method.</span><br><span class="line"> *</span><br><span class="line"> * <span class="doctag">@param</span> activity The activity being created.</span><br><span class="line"> * <span class="doctag">@param</span> icicle The previously frozen state (or null) to pass through to onCreate().</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callActivityOnCreate</span><span class="params">(Activity activity, Bundle icicle)</span> </span>&#123;</span><br><span class="line">    prePerformCreate(activity);</span><br><span class="line">    activity.performCreate(icicle);</span><br><span class="line">    postPerformCreate(activity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>activity.performCreate(icicle)</code>会调用到Activity中的对应方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">performCreate</span><span class="params">(Bundle icicle)</span> </span>&#123;</span><br><span class="line">    restoreHasCurrentPermissionRequest(icicle);</span><br><span class="line">    onCreate(icicle);</span><br><span class="line">    mActivityTransitionState.readState(icicle);</span><br><span class="line">    performCreateCommon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>onCreate(icicle)</code>会触发Activity的onCreate生命周期回调，至此Activity的启动流程大家就非常熟悉了，不再赘述。</p>
<p>Instrumentation源码中除了本小节之前的内容，其他主要就是跟Activity生命周期相关的逻辑，除了上述分析的启动逻辑，还有onStart()、onPause()、onResume()、onStop()、onDestroy()等过程，就不在一一分析。</p>
<h4 id="ActivityThread_u4E2D_u7684Instrumentation_u662F_u4F55_u65F6_u521D_u59CB_u5316_u7684"><a href="#ActivityThread_u4E2D_u7684Instrumentation_u662F_u4F55_u65F6_u521D_u59CB_u5316_u7684" class="headerlink" title="ActivityThread中的Instrumentation是何时初始化的"></a>ActivityThread中的Instrumentation是何时初始化的</h4><p>Instrumentation在ActivityThread中的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Instrumentation mInstrumentation;</span><br></pre></td></tr></table></figure>
<p>从前文的分析可知，Activity创建之后调用attach方法中传入的Instrumentation就是ActivityThread中的，那么在ActivityThread中的Instrumentation是何时初始化的呢？</p>
<p>在ActivityThread中搜索，发现有几处为mInstrumentation赋值的地方：</p>
<p>1.ActivityThread的attach方法，方法声明为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当system参数为true时，会执行到如下为mInstrumentation赋值的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">    ContextImpl context = ContextImpl.createAppContext(</span><br><span class="line">            <span class="keyword">this</span>, getSystemContext().mPackageInfo);</span><br><span class="line">    mInitialApplication = context.mPackageInfo.makeApplication(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">    mInitialApplication.onCreate();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"Unable to instantiate Application():"</span> + e.toString(), e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在主线程ActivityThread的main方法中system参数为false，故此时没有创建Instrumentation对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">thread.attach(<span class="keyword">false</span>);</span><br></pre></td></tr></table></figure>
<p>2.ActivityThread的handleBindApplication(AppBindData data)方法中，有如下逻辑：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">final</span> <span class="type">InstrumentationInfo</span> ii;</span><br><span class="line"><span class="title">if</span> (<span class="typedef"><span class="keyword">data</span>.instrumentationName != null) <span class="container">&#123;</span><br><span class="line">    <span class="title">try</span> &#123;</span><br><span class="line">        <span class="title">ii</span> = <span class="title">new</span> <span class="type">ApplicationPackageManager</span>(<span class="title">null</span>, <span class="title">getPackageManager</span>())</span><br><span class="line">                .<span class="title">getInstrumentationInfo</span>(<span class="title">data</span>.<span class="title">instrumentationName</span>, 0);</span><br><span class="line">    &#125;</span> catch <span class="container">(<span class="type">PackageManager</span>.<span class="type">NameNotFoundException</span> <span class="title">e</span>)</span> <span class="container">&#123;</span><br><span class="line">        <span class="title">throw</span> <span class="title">new</span> <span class="type">RuntimeException</span>(</span><br><span class="line">                "<span class="type">Unable</span> <span class="title">to</span> <span class="title">find</span> <span class="title">instrumentation</span> <span class="title">info</span> <span class="title">for</span>: " + <span class="title">data</span>.<span class="title">instrumentationName</span>);</span><br><span class="line">    &#125;</span></span></span><br><span class="line"></span><br><span class="line">    mInstrumentationPackageName = ii.packageName;</span><br><span class="line">    mInstrumentationAppDir = ii.sourceDir;</span><br><span class="line">    mInstrumentationSplitAppDirs = ii.splitSourceDirs;</span><br><span class="line">    mInstrumentationLibDir = getInstrumentationLibrary(<span class="typedef"><span class="keyword">data</span>.appInfo, ii);</span></span><br><span class="line">    mInstrumentedAppDir = <span class="typedef"><span class="keyword">data</span>.info.getAppDir<span class="container">()</span>;</span></span><br><span class="line">    mInstrumentedSplitAppDirs = <span class="typedef"><span class="keyword">data</span>.info.getSplitAppDirs<span class="container">()</span>;</span></span><br><span class="line">    mInstrumentedLibDir = <span class="typedef"><span class="keyword">data</span>.info.getLibDir<span class="container">()</span>;</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ii = null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Continue loading instrumentation.</span></span><br><span class="line"><span class="keyword">if</span> (ii != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> ApplicationInfo instrApp = <span class="keyword">new</span> ApplicationInfo();</span><br><span class="line">    ii.copyTo(instrApp);</span><br><span class="line">    instrApp.initForUser(UserHandle.myUserId());</span><br><span class="line">    <span class="keyword">final</span> LoadedApk pi = getPackageInfo(instrApp, data.compatInfo,</span><br><span class="line">            appContext.getClassLoader(), <span class="keyword">false</span>, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="keyword">this</span>, pi);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ClassLoader cl = instrContext.getClassLoader();</span><br><span class="line">        mInstrumentation = (Instrumentation)</span><br><span class="line">            cl.loadClass(data.instrumentationName.getClassName()).newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">            <span class="string">"Unable to instantiate instrumentation "</span></span><br><span class="line">            + data.instrumentationName + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> ComponentName component = <span class="keyword">new</span> ComponentName(ii.packageName, ii.name);</span><br><span class="line">    mInstrumentation.init(<span class="keyword">this</span>, instrContext, appContext, component,</span><br><span class="line">            data.instrumentationWatcher, data.instrumentationUiAutomationConnection);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mProfiler.profileFile != <span class="keyword">null</span> &amp;&amp; !ii.handleProfiling</span><br><span class="line">            &amp;&amp; mProfiler.profileFd == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mProfiler.handlingProfiling = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">final</span> File file = <span class="keyword">new</span> File(mProfiler.profileFile);</span><br><span class="line">        file.getParentFile().mkdirs();</span><br><span class="line">        Debug.startMethodTracing(file.toString(), <span class="number">8</span> * <span class="number">1024</span> * <span class="number">1024</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当data.instrumentationName不为null时，即必须在AndroidManifest.xml中声明了Instrumentation标签才行，否则不会执行，此时会构造一个InstrumentationInfo对象ii，接下来会使用类加载器构造一个Instrumentation实例。</p>
<p>如果AndroidManifest.xml中没有声明Instrumentation标签，即data.instrumentationName为null时，则直接通过new来创建一个Instrumentation实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mInstrumentation = <span class="keyword">new</span> Instrumentation();</span><br></pre></td></tr></table></figure>
<p>一般应用都会在ActivityThread启动后，通过此方式创建Instrumentation的实例，该行为在应用其他组件创建之前。在一个应用进程中，各个Activity中的Instrumentation都是由ActivityThread传入的，它们归根溯源是同一个。</p>
<h3 id="Instrumentation_u603B_u7ED3"><a href="#Instrumentation_u603B_u7ED3" class="headerlink" title="Instrumentation总结"></a>Instrumentation总结</h3><p>通过上述源码梳理，发现Instrumentation是一个非常重要的类，甚至Application、Activity的生命周期都与其相关。它的功能大概可以总结为三个方面：</p>
<ol>
<li><p>参与Application、Activity的生命周期逻辑</p>
</li>
<li><p>用于Android单元测试</p>
</li>
<li><p>由于Instrumentation独特的运行时机，对于Application、Activity举足轻重的控制权，因此可以进行一些hook操作，具体可参考以下几篇文章：</p>
<ol>
<li><a href="http://m.blog.csdn.net/article/details?id=52078445" target="_blank" rel="external">Android中Hook Instrumentation的一些思考</a></li>
<li><a href="http://tech.meituan.com/mt-android-auto-split-dex.html" target="_blank" rel="external">美团Android DEX自动拆包及动态加载简介</a></li>
<li><a href="http://zhengxiaoyong.me/2016/07/18/Android%E7%AB%AF%E5%BA%94%E7%94%A8%E7%A7%92%E5%BC%80%E4%BC%98%E5%8C%96%E4%BD%93%E9%AA%8C/" target="_blank" rel="external">Android端应用秒开优化体验</a></li>
</ol>
<p>​</p>
</li>
</ol>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://aspook.com/2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/" data-id="ciyzfb35c00773x5sppa7k84u" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Instrumentation/">Instrumentation</a><a href="/tags/activity启动流程/">activity启动流程</a></div><div class="post-nav"><a href="/2017/01/19/面对五花八门的新技术，如何看待与学习/" class="next">面对五花八门的新技术，如何看待与学习</a></div><div id="disqus_thread"><script>var disqus_shortname = 'aspook';
var disqus_identifier = '2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/';
var disqus_title = 'Android Instrumentation源码分析（附Activity启动流程）';
var disqus_url = 'http://aspook.com/2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//aspook.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://aspook.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithms/">Algorithms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GIS/">GIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂谈/">杂谈</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/非递归实现/" style="font-size: 15px;">非递归实现</a> <a href="/tags/APK瘦身/" style="font-size: 15px;">APK瘦身</a> <a href="/tags/微信支付/" style="font-size: 15px;">微信支付</a> <a href="/tags/微信wap支付/" style="font-size: 15px;">微信wap支付</a> <a href="/tags/微信网页支付/" style="font-size: 15px;">微信网页支付</a> <a href="/tags/诗词/" style="font-size: 15px;">诗词</a> <a href="/tags/历史/" style="font-size: 15px;">历史</a> <a href="/tags/Web地图/" style="font-size: 15px;">Web地图</a> <a href="/tags/矢量渲染/" style="font-size: 15px;">矢量渲染</a> <a href="/tags/切片地图/" style="font-size: 15px;">切片地图</a> <a href="/tags/栅格地图/" style="font-size: 15px;">栅格地图</a> <a href="/tags/养花/" style="font-size: 15px;">养花</a> <a href="/tags/读书/" style="font-size: 15px;">读书</a> <a href="/tags/Java泛型/" style="font-size: 15px;">Java泛型</a> <a href="/tags/clone/" style="font-size: 15px;">clone</a> <a href="/tags/对象克隆/" style="font-size: 15px;">对象克隆</a> <a href="/tags/Android线程/" style="font-size: 15px;">Android线程</a> <a href="/tags/线程通信/" style="font-size: 15px;">线程通信</a> <a href="/tags/AsyncTask/" style="font-size: 15px;">AsyncTask</a> <a href="/tags/工具类/" style="font-size: 15px;">工具类</a> <a href="/tags/公有构造函数/" style="font-size: 15px;">公有构造函数</a> <a href="/tags/诗歌/" style="font-size: 15px;">诗歌</a> <a href="/tags/65536/" style="font-size: 15px;">65536</a> <a href="/tags/64K-method/" style="font-size: 15px;">64K method</a> <a href="/tags/App安全/" style="font-size: 15px;">App安全</a> <a href="/tags/Intent/" style="font-size: 15px;">Intent</a> <a href="/tags/垃圾收集算法/" style="font-size: 15px;">垃圾收集算法</a> <a href="/tags/在南下的火车上/" style="font-size: 15px;">在南下的火车上</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/第三方框架/" style="font-size: 15px;">第三方框架</a> <a href="/tags/Android适配/" style="font-size: 15px;">Android适配</a> <a href="/tags/人生信条/" style="font-size: 15px;">人生信条</a> <a href="/tags/Context/" style="font-size: 15px;">Context</a> <a href="/tags/二叉树/" style="font-size: 15px;">二叉树</a> <a href="/tags/二叉树遍历/" style="font-size: 15px;">二叉树遍历</a> <a href="/tags/深度优先遍历/" style="font-size: 15px;">深度优先遍历</a> <a href="/tags/广度优先遍历/" style="font-size: 15px;">广度优先遍历</a> <a href="/tags/如何看待与学习新技术/" style="font-size: 15px;">如何看待与学习新技术</a> <a href="/tags/life/" style="font-size: 15px;">life</a> <a href="/tags/AndroidManifest/" style="font-size: 15px;">AndroidManifest</a> <a href="/tags/activity-alias/" style="font-size: 15px;">activity-alias</a> <a href="/tags/瓦片地图/" style="font-size: 15px;">瓦片地图</a> <a href="/tags/Messenger/" style="font-size: 15px;">Messenger</a> <a href="/tags/进程间通信/" style="font-size: 15px;">进程间通信</a> <a href="/tags/LRU/" style="font-size: 15px;">LRU</a> <a href="/tags/Java内存模型/" style="font-size: 15px;">Java内存模型</a> <a href="/tags/JVM内存模型/" style="font-size: 15px;">JVM内存模型</a> <a href="/tags/Java内存分配/" style="font-size: 15px;">Java内存分配</a> <a href="/tags/Bundle/" style="font-size: 15px;">Bundle</a> <a href="/tags/源码解析/" style="font-size: 15px;">源码解析</a> <a href="/tags/内存优化/" style="font-size: 15px;">内存优化</a> <a href="/tags/高性能编码/" style="font-size: 15px;">高性能编码</a> <a href="/tags/AIDL/" style="font-size: 15px;">AIDL</a> <a href="/tags/Binder/" style="font-size: 15px;">Binder</a> <a href="/tags/Android消息机制源码解析/" style="font-size: 15px;">Android消息机制源码解析</a> <a href="/tags/MessageQueue/" style="font-size: 15px;">MessageQueue</a> <a href="/tags/Handler/" style="font-size: 15px;">Handler</a> <a href="/tags/Looper/" style="font-size: 15px;">Looper</a> <a href="/tags/Message/" style="font-size: 15px;">Message</a> <a href="/tags/Android文件存储/" style="font-size: 15px;">Android文件存储</a> <a href="/tags/内部存储/" style="font-size: 15px;">内部存储</a> <a href="/tags/外部存储/" style="font-size: 15px;">外部存储</a> <a href="/tags/微信分享/" style="font-size: 15px;">微信分享</a> <a href="/tags/分享闭环/" style="font-size: 15px;">分享闭环</a> <a href="/tags/Android书籍推荐/" style="font-size: 15px;">Android书籍推荐</a> <a href="/tags/App生命周期/" style="font-size: 15px;">App生命周期</a> <a href="/tags/Broadcast/" style="font-size: 15px;">Broadcast</a> <a href="/tags/Android广播/" style="font-size: 15px;">Android广播</a> <a href="/tags/Android布局性能优化/" style="font-size: 15px;">Android布局性能优化</a> <a href="/tags/Android图片缓存/" style="font-size: 15px;">Android图片缓存</a> <a href="/tags/Window/" style="font-size: 15px;">Window</a> <a href="/tags/Android-Studio/" style="font-size: 15px;">Android Studio</a> <a href="/tags/Instant-Run/" style="font-size: 15px;">Instant Run</a> <a href="/tags/Instrumentation/" style="font-size: 15px;">Instrumentation</a> <a href="/tags/activity启动流程/" style="font-size: 15px;">activity启动流程</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/02/10/Android-Instrumentation源码分析（附Activity启动流程）/">Android Instrumentation源码分析（附Activity启动流程）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/19/面对五花八门的新技术，如何看待与学习/">面对五花八门的新技术，如何看待与学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/19/App内存占用优化/">App内存占用优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/01/19/Android高性能编码最佳实践/">Android高性能编码最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/19/Android布局性能优化指南/">Android布局性能优化指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/12/15/APK瘦身指南/">APK瘦身指南</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/27/如何配置方法数超过64K的应用/">如何配置方法数超过64K的应用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/25/关于日益泛滥的Android第三方框架/">关于日益泛滥的Android第三方框架</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/30/Messenger进程间通信及其原理/">Messenger进程间通信及其原理</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/30/信条/">信条</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//aspook.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://blog.csdn.net/ahence" title="aspook" target="_blank">aspook</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Aspook.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>